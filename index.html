<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Time Entry Rewrite</title>
  <style>
    :root {
      /* Modern Color Palette */
      --shell-bg: #f7f9fc;
      --app-bg: #ffffff;
      --sidebar-bg: #1e293b;
      --sidebar-bg-hover: #334155;
      --sidebar-border: #0f172a;
      --sidebar-active: #3b82f6;

      /* Primary Colors */
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --accent-soft: rgba(59, 130, 246, 0.08);
      --accent-medium: rgba(59, 130, 246, 0.15);

      /* Semantic Colors */
      --success: #10b981;
      --success-soft: rgba(16, 185, 129, 0.1);
      --danger: #ef4444;
      --danger-soft: rgba(239, 68, 68, 0.1);
      --warning: #f59e0b;
      --warning-soft: rgba(245, 158, 11, 0.1);

      /* Neutral Palette */
      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-300: #cbd5e1;
      --gray-400: #94a3b8;
      --gray-500: #64748b;
      --gray-600: #475569;
      --gray-700: #334155;
      --gray-800: #1e293b;
      --gray-900: #0f172a;

      /* Text Colors */
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-tertiary: #94a3b8;

      /* Border & Shadow */
      --border-light: #e2e8f0;
      --border-medium: #cbd5e1;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

      /* Spacing Scale */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      --space-10: 40px;
      --space-12: 48px;

      /* Border Radius */
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
      --radius-full: 9999px;

      /* Transitions */
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter", "Roboto", "Helvetica Neue", sans-serif;
      font-size: 15px;
      line-height: 1.6;
      background: var(--shell-bg);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .root {
      flex: 1;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    /* ---------- LOGIN SCREEN ---------- */

    #loginScreen {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-6);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .login-card {
      width: 100%;
      max-width: 460px;
      background: #ffffff;
      border-radius: var(--radius-xl);
      padding: var(--space-10);
      box-shadow: var(--shadow-xl);
      border: 1px solid var(--border-light);
      animation: slideUp 0.4s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .login-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: var(--space-2);
      display: flex;
      align-items: center;
      gap: var(--space-3);
      color: var(--text-primary);
      letter-spacing: -0.02em;
    }

    .login-title span.logo-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      border-radius: var(--radius-lg);
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      font-size: 20px;
      font-weight: 700;
      color: #ffffff;
      box-shadow: var(--shadow-md);
    }

    .login-subtitle {
      font-size: 15px;
      color: var(--text-secondary);
      margin-bottom: var(--space-8);
      line-height: 1.6;
    }

    .login-subtitle code {
      font-family: "SF Mono", Menlo, Consolas, monospace;
      font-size: 13px;
      background: var(--gray-100);
      padding: 3px 6px;
      border-radius: var(--radius-sm);
      color: var(--accent);
      font-weight: 500;
    }

    .login-grid {
      display: grid;
      gap: var(--space-5);
      margin-bottom: var(--space-6);
    }

    .login-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-2);
      display: block;
    }

    .login-input {
      width: 100%;
      height: 48px;
      padding: 0 var(--space-4);
      border-radius: var(--radius-md);
      border: 2px solid var(--border-light);
      background: var(--gray-50);
      color: var(--text-primary);
      font-size: 15px;
      outline: none;
      transition: all var(--transition-fast);
      font-family: inherit;
    }

    .login-input::placeholder {
      color: var(--text-tertiary);
    }

    .login-input:hover {
      border-color: var(--border-medium);
      background: #ffffff;
    }

    .login-input:focus {
      border-color: var(--accent);
      background: #ffffff;
      box-shadow: 0 0 0 4px var(--accent-soft);
    }

    .login-footer-row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: var(--space-4);
      margin-top: var(--space-2);
    }

    .login-hint {
      font-size: 13px;
      color: var(--text-tertiary);
      line-height: 1.5;
    }

    .login-hint code {
      font-family: "SF Mono", Menlo, Consolas, monospace;
      font-size: 12px;
      background: var(--gray-100);
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
    }

    .login-button {
      height: 48px;
      border: none;
      border-radius: var(--radius-md);
      padding: 0 var(--space-6);
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      color: #ffffff;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      transition: all var(--transition-base);
      box-shadow: var(--shadow-sm);
      white-space: nowrap;
    }

    .login-button:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .login-button:active {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }

    .login-status {
      margin-top: var(--space-4);
      font-size: 14px;
      min-height: 20px;
      color: var(--danger);
      padding: var(--space-3);
      border-radius: var(--radius-md);
      background: var(--danger-soft);
      display: none;
    }

    .login-status:not(:empty) {
      display: block;
    }

    .login-status.error {
      color: var(--danger);
      background: var(--danger-soft);
    }

    /* ---------- APP LAYOUT ---------- */

    #appScreen {
      flex: 1;
      display: none;
      padding: 0;
    }

    .app-shell {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100%;
      background: var(--gray-50);
      overflow: hidden;
    }

    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 var(--space-8);
      height: 72px;
      background: #ffffff;
      color: var(--text-primary);
      border-bottom: 1px solid var(--border-light);
      box-shadow: var(--shadow-sm);
      z-index: 10;
    }

    .app-header-title {
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: var(--space-4);
      color: var(--text-primary);
      letter-spacing: -0.01em;
    }

    .app-header-title span.sub {
      font-size: 14px;
      color: var(--text-tertiary);
      font-weight: 400;
      padding-left: var(--space-4);
      margin-left: var(--space-4);
      border-left: 2px solid var(--border-light);
    }

    .app-user-chip {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-full);
      border: 1px solid var(--border-light);
      background: var(--gray-50);
      font-size: 14px;
      transition: all var(--transition-fast);
    }

    .app-user-chip:hover {
      background: var(--gray-100);
      border-color: var(--border-medium);
    }

    .role-pill {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: var(--radius-full);
      background: var(--success-soft);
      color: var(--success);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .role-pill.admin {
      background: var(--warning-soft);
      color: var(--warning);
    }

    .logout-link {
      cursor: pointer;
      font-size: 14px;
      color: var(--text-secondary);
      text-decoration: none;
      font-weight: 500;
      transition: color var(--transition-fast);
    }

    .logout-link:hover {
      color: var(--accent);
    }

    .app-body {
      flex: 1;
      display: flex;
      min-height: 0;
    }

    /* ---------- SIDEBAR ---------- */

    .sidebar {
      width: 260px;
      background: var(--sidebar-bg);
      color: var(--gray-200);
      border-right: 1px solid var(--sidebar-border);
      display: flex;
      flex-direction: column;
      padding: var(--space-6) var(--space-4);
      gap: var(--space-2);
    }

    .nav-group-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--gray-400);
      padding: var(--space-3) var(--space-3);
      margin-top: var(--space-4);
      font-weight: 600;
    }

    .nav-group-label:first-child {
      margin-top: 0;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-3);
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      color: var(--gray-300);
      border: 1px solid transparent;
      transition: all var(--transition-fast);
      position: relative;
    }

    .nav-item span.icon {
      font-size: 18px;
      width: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform var(--transition-fast);
    }

    .nav-item:hover {
      background: var(--sidebar-bg-hover);
      color: #ffffff;
      transform: translateX(2px);
    }

    .nav-item:hover span.icon {
      transform: scale(1.08);
    }

    .nav-item.active {
      background: var(--sidebar-active);
      color: #ffffff;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }

    .nav-item.active::before {
      content: '';
      position: absolute;
      left: -var(--space-4);
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 24px;
      background: #ffffff;
      border-radius: 0 2px 2px 0;
    }

    .sidebar-footer {
      margin-top: auto;
      padding: var(--space-4) var(--space-3);
      font-size: 12px;
      color: var(--gray-500);
      line-height: 1.5;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      margin-top: var(--space-8);
    }

    /* ---------- MAIN CONTENT ---------- */

    .content {
      flex: 1;
      padding: var(--space-8);
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: var(--space-6);
      background: var(--gray-50);
      overflow-y: auto;
    }

    .view {
      flex: 1;
      display: none;
      min-height: 0;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .view.active {
      display: flex;
    }

    .center-wrap {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      gap: var(--space-6);
    }

    .center-wrap.single {
      max-width: 1400px;
    }

    .pane {
      background: #ffffff;
      border-radius: var(--radius-lg);
      padding: var(--space-8);
      border: 1px solid var(--border-light);
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-sm);
      transition: all var(--transition-base);
    }

    .pane:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--border-medium);
    }

    .pane-left {
      flex: 0 0 42%;
      min-width: 420px;
    }

    .pane-right {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
    }

    label {
      font-size: 14px;
      font-weight: 600;
      margin-top: var(--space-5);
      margin-bottom: var(--space-2);
      color: var(--text-primary);
      display: block;
    }

    label:first-of-type {
      margin-top: 0;
    }

    input, select, textarea {
      margin-top: 0;
      padding: 0 var(--space-4);
      height: 44px;
      font-size: 15px;
      border-radius: var(--radius-md);
      border: 2px solid var(--border-light);
      box-sizing: border-box;
      width: 100%;
      background: var(--gray-50);
      color: var(--text-primary);
      outline: none;
      transition: all var(--transition-fast);
      font-family: inherit;
    }

    select {
      background-color: var(--gray-50);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2364748b' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
      appearance: none;
    }

    textarea {
      resize: vertical;
      padding: var(--space-3) var(--space-4);
      height: auto;
      min-height: 100px;
      line-height: 1.6;
    }

    input::placeholder,
    textarea::placeholder {
      color: var(--text-tertiary);
    }

    input:hover,
    select:hover,
    textarea:hover {
      border-color: var(--border-medium);
      background: #ffffff;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--accent);
      background: #ffffff;
      box-shadow: 0 0 0 4px var(--accent-soft);
    }

    input[type="number"] {
      appearance: textfield;
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    button {
      height: 44px;
      padding: 0 var(--space-6);
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      color: #ffffff !important;
      border: none;
      cursor: pointer;
      margin-top: var(--space-5);
      font-weight: 600;
      font-size: 15px;
      border-radius: var(--radius-md);
      transition: all var(--transition-base);
      box-shadow: var(--shadow-sm);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      font-family: inherit;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    button:active {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }

    button.secondary {
      background: var(--gray-600);
      color: #ffffff !important;
    }

    button.secondary:hover {
      background: var(--gray-700);
    }

    button.danger {
      background: var(--danger);
      color: #ffffff !important;
    }

    button.danger:hover {
      background: #dc2626;
    }

    button.small {
      height: 36px;
      font-size: 13px;
      padding: 0 var(--space-4);
    }

    button.upload-btn {
      background: var(--success);
      color: #ffffff !important;
      height: 36px;
      font-size: 13px;
      padding: 0 var(--space-4);
      margin-top: var(--space-2);
    }

    button.upload-btn:hover {
      background: #059669;
    }

    .button-row {
      display: flex;
      gap: var(--space-3);
      margin-top: var(--space-5);
    }

    .status {
      font-size: 14px;
      margin-top: var(--space-4);
      padding: var(--space-3) var(--space-4);
      min-height: 20px;
      color: var(--text-secondary);
      background: var(--gray-100);
      border-radius: var(--radius-md);
      border-left: 3px solid var(--accent);
    }

    .status:empty {
      display: none;
    }

    .output-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
      overflow: auto;
    }

    .output-block {
      margin-bottom: var(--space-2);
    }

    .output-title {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: var(--space-2);
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    pre {
      background: var(--gray-50);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      font-family: "SF Mono", Menlo, "Monaco", "Courier New", monospace;
      font-size: 14px;
      white-space: pre-wrap;
      border: 1px solid var(--border-light);
      min-height: 60px;
      color: var(--text-primary);
      line-height: 1.7;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.03);
      transition: all var(--transition-fast);
    }

    pre:not(:empty):hover {
      border-color: var(--accent);
      background: #ffffff;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    }

    .grid-bottom {
      margin-top: var(--space-6);
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: var(--space-6);
      min-height: 0;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 14px;
      color: var(--text-primary);
      background: white;
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-light);
    }

    th, td {
      border-bottom: 1px solid var(--border-light);
      padding: var(--space-4);
      text-align: left;
      vertical-align: middle;
    }

    tbody tr {
      transition: all var(--transition-fast);
    }

    tbody tr:hover {
      background: var(--gray-50);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    th {
      background: var(--gray-100);
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
      border-bottom: 2px solid var(--border-medium);
      padding: var(--space-4);
    }

    .section-title {
      font-weight: 700;
      font-size: 18px;
      margin-bottom: var(--space-5);
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: var(--space-2);
      letter-spacing: -0.01em;
    }

    .pill-muted {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: var(--radius-full);
      background: var(--gray-100);
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-left: var(--space-2);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: var(--radius-full);
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .badge-danger {
      background: var(--danger-soft);
      color: var(--danger);
    }

    .small {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .table-scroll {
      max-height: 200px;
      overflow-y: auto;
      display: block;
    }

    .table-scroll table {
      width: 100%;
    }

    .upload-section {
      margin-top: var(--space-5);
      padding: var(--space-5);
      background: var(--gray-50);
      border: 2px dashed var(--border-medium);
      border-radius: var(--radius-lg);
      transition: all var(--transition-fast);
    }

    .upload-section:hover {
      border-color: var(--accent);
      background: var(--accent-soft);
    }

    .upload-section-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-3);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .file-input-wrapper {
      position: relative;
      display: inline-block;
      width: 100%;
    }

    input[type="file"] {
      font-size: 13px;
      padding: var(--space-3);
      height: auto;
      margin-top: 0;
      border: 2px solid var(--border-light);
      background: #ffffff;
      cursor: pointer;
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
    }

    input[type="file"]:hover {
      border-color: var(--border-medium);
    }

    input[type="file"]::file-selector-button {
      padding: var(--space-2) var(--space-4);
      margin-right: var(--space-3);
      border: none;
      background: var(--gray-200);
      color: var(--text-primary);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all var(--transition-fast);
    }

    input[type="file"]::file-selector-button:hover {
      background: var(--gray-300);
    }

    .upload-hint {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-top: var(--space-2);
      line-height: 1.5;
    }

    .divider {
      height: 1px;
      background: var(--border-light);
      margin: var(--space-6) 0;
    }
    /* ---------- TAGGING BADGES & BUTTONS ---------- */

    .badge-success {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      background: var(--success);
      color: white;
      border-radius: var(--radius-md);
      font-size: 13px;
      font-weight: 600;
      margin-right: var(--space-2);
      box-shadow: var(--shadow-sm);
    }

    .badge-failure {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      background: var(--danger);
      color: white;
      border-radius: var(--radius-md);
      font-size: 13px;
      font-weight: 600;
      margin-right: var(--space-2);
      box-shadow: var(--shadow-sm);
    }

    .badge-pending {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      background: var(--gray-500);
      color: white;
      border-radius: var(--radius-md);
      font-size: 13px;
      font-weight: 600;
      margin-right: var(--space-2);
      box-shadow: var(--shadow-sm);
    }

    .btn-tag {
      padding: var(--space-2) var(--space-4);
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      margin-right: var(--space-2);
      margin-top: 0 !important;
      transition: all var(--transition-base);
      box-shadow: var(--shadow-sm);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 32px;
    }

    .btn-tag:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .btn-tag:active {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-failure {
      background: var(--danger);
      color: white;
    }

    .btn-failure:hover {
      background: #dc2626;
    }

    /* ---------- MODAL ---------- */

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.2s ease-out;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: #ffffff;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: slideUp 0.3s ease-out;
    }

    .modal-header {
      padding: var(--space-6) var(--space-8);
      border-bottom: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-md);
      border: none;
      background: var(--gray-100);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all var(--transition-fast);
      padding: 0;
      margin: 0;
    }

    .modal-close:hover {
      background: var(--gray-200);
      color: var(--text-primary);
      transform: none;
    }

    .modal-body {
      padding: var(--space-8);
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      padding: var(--space-6) var(--space-8);
      border-top: 1px solid var(--border-light);
      display: flex;
      gap: var(--space-3);
      justify-content: flex-end;
      background: var(--gray-50);
    }

    .modal-footer button {
      margin-top: 0;
    }

    .form-grid {
      display: grid;
      gap: var(--space-5);
    }

    .action-btn {
      padding: var(--space-2) var(--space-3);
      border: none;
      background: transparent;
      color: var(--accent);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      border-radius: var(--radius-sm);
      transition: all var(--transition-fast);
      margin: 0;
      height: auto;
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
    }

    .action-btn:hover {
      background: var(--accent-soft);
      transform: none;
      box-shadow: none;
    }

    .action-btn.danger {
      color: var(--danger);
    }

    .action-btn.danger:hover {
      background: var(--danger-soft);
    }

    /* ---------- LOADING SPINNER ---------- */

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(2px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      animation: fadeIn 0.15s ease-out;
    }

    .loading-overlay.active {
      display: flex;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading-text {
      position: absolute;
      margin-top: 90px;
      color: #ffffff;
      font-size: 14px;
      font-weight: 500;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    /* ---------- SEARCHABLE DROPDOWN ---------- */

    .searchable-dropdown {
      position: relative;
      width: 100%;
    }

    .searchable-dropdown input.search-input {
      margin-top: 0;
      cursor: pointer;
    }

    .searchable-dropdown .dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #ffffff;
      border: 2px solid var(--accent);
      border-top: none;
      border-radius: 0 0 var(--radius-md) var(--radius-md);
      max-height: 300px;
      overflow-y: auto;
      z-index: 100;
      display: none;
      box-shadow: var(--shadow-lg);
    }

    .searchable-dropdown .dropdown-list.active {
      display: block;
    }

    .searchable-dropdown .dropdown-item {
      padding: var(--space-3) var(--space-4);
      cursor: pointer;
      transition: all var(--transition-fast);
      font-size: 15px;
      color: var(--text-primary);
    }

    .searchable-dropdown .dropdown-item:hover {
      background: var(--accent-soft);
      color: var(--accent);
    }

    .searchable-dropdown .dropdown-item.selected {
      background: var(--accent);
      color: #ffffff;
      font-weight: 600;
    }

    .searchable-dropdown .dropdown-item.no-results {
      color: var(--text-tertiary);
      cursor: default;
      font-style: italic;
    }

    .searchable-dropdown .dropdown-item.no-results:hover {
      background: transparent;
      color: var(--text-tertiary);
    }

    /* ---------- PAGINATION ---------- */

    .pagination-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: var(--space-4);
      padding: var(--space-4);
      border-top: 1px solid var(--border-light);
    }

    .pagination-info {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .pagination-controls {
      display: flex;
      gap: var(--space-2);
      align-items: center;
    }

    .pagination-btn {
      height: 36px;
      min-width: 36px;
      padding: 0 var(--space-3);
      border: 1px solid var(--border-medium);
      background: #ffffff;
      color: var(--text-primary);
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all var(--transition-fast);
      margin-top: 0;
    }

    .pagination-btn:hover:not(:disabled) {
      background: var(--accent);
      color: #ffffff;
      border-color: var(--accent);
      transform: none;
      box-shadow: var(--shadow-sm);
    }

    .pagination-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      background: var(--gray-100);
      border-color: var(--border-light);
      color: var(--text-tertiary);
    }

    .pagination-btn.active {
      background: var(--accent);
      color: #ffffff;
      border-color: var(--accent);
      font-weight: 600;
    }

    /* ---------- MOBILE & TABLET RESPONSIVENESS ---------- */

    @media (max-width: 1024px) {
      /* Tablet landscape */
      .center-wrap {
        flex-direction: column;
        gap: var(--space-4);
      }

      .pane-left, .pane-right {
        flex: 1;
        min-width: 100%;
      }

      .grid-bottom {
        grid-template-columns: 1fr;
      }

      .app-header {
        padding: 0 var(--space-4);
        height: 64px;
      }

      .app-header-title {
        font-size: 18px;
      }

      .app-header-title span.sub {
        display: none;
      }

      .content {
        padding: var(--space-4);
      }

      .sidebar {
        width: 220px;
        padding: var(--space-4) var(--space-3);
      }
    }

    @media (max-width: 768px) {
      /* Tablet portrait and mobile */
      body {
        font-size: 14px;
      }

      .app-shell {
        flex-direction: column;
      }

      .app-body {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        flex-direction: row;
        overflow-x: auto;
        padding: var(--space-3);
        gap: var(--space-2);
        border-right: none;
        border-bottom: 1px solid var(--sidebar-border);
      }

      .nav-group-label {
        display: none;
      }

      .nav-item {
        white-space: nowrap;
        min-width: auto;
      }

      .sidebar-footer {
        display: none;
      }

      .app-header {
        height: 56px;
        padding: 0 var(--space-3);
      }

      .app-header-title {
        font-size: 16px;
      }

      .content {
        padding: var(--space-3);
      }

      .pane {
        padding: var(--space-4);
      }

      .login-card {
        max-width: 100%;
        padding: var(--space-6);
      }

      .login-title {
        font-size: 24px;
      }

      .modal {
        max-width: 95%;
        max-height: 95vh;
      }

      .modal-body {
        padding: var(--space-4);
      }

      .modal-header, .modal-footer {
        padding: var(--space-4);
      }

      table {
        font-size: 13px;
      }

      th, td {
        padding: var(--space-3);
      }

      button {
        height: 40px;
        font-size: 14px;
      }

      input, select, textarea {
        font-size: 16px; /* Prevents zoom on iOS */
        height: 48px;
      }

      .action-btn {
        font-size: 12px;
        padding: var(--space-2);
      }

      .pagination-btn {
        height: 40px;
        min-width: 40px;
        font-size: 13px;
      }

      .pagination-container {
        flex-direction: column;
        gap: var(--space-3);
        align-items: flex-start;
      }

      .pagination-controls {
        width: 100%;
        justify-content: center;
      }

      .app-user-chip {
        font-size: 12px;
        padding: var(--space-1) var(--space-3);
      }

      .role-pill {
        font-size: 10px;
        padding: 3px 8px;
      }

      .logout-link {
        font-size: 12px;
      }
    }

  </style>
</head>
<body>
  <div class="root">
    <!-- Login Screen -->
    <div id="loginScreen">
      <div class="login-card">
        <div class="login-title">
          <span class="logo-pill">AI</span>
          Time Entry Rewrite
        </div>
        <div class="login-subtitle">
          Rewrite and normalize billing narratives with client-specific rules.<br>
          Use <code>demo/demo123</code> (user) or <code>admin/admin123</code> (admin).
        </div>

        <div class="login-grid">
          <div>
            <div class="login-label">Username</div>
            <input id="username" class="login-input" value="demo" />
          </div>
          <div>
            <div class="login-label">Password</div>
            <input id="password" class="login-input" type="password" value="demo123" />
          </div>
        </div>

        <div class="login-footer-row">
          <div class="login-hint">
            <div>Standard user: <code>demo / demo123</code></div>
            <div>Admin review: <code>admin / admin123</code></div>
          </div>
          <button id="loginBtn" class="login-button">
            <span>Enter workspace</span>
          </button>
        </div>

        <div id="loginStatus" class="login-status"></div>
      </div>
    </div>

    <!-- App Screen -->
    <div id="appScreen">
      <div class="app-shell">
        <div class="app-header">
          <div class="app-header-title">
            <span>AI Time Entry Rewrite</span>
            <span class="sub">Client-aware billing narrative engine</span>
          </div>
          <div class="app-user-chip">
            <span id="userLabel">@user</span>
            <span id="rolePill" class="role-pill">user</span>
            <span class="logout-link" id="logoutLink">Logout</span>
          </div>
        </div>

        <div class="app-body">
          <!-- Sidebar Navigation -->
          <aside class="sidebar">
            <div class="nav-group-label">Workspace</div>
            <div id="navRewrite" class="nav-item active">
              <span class="icon">üè†</span>
              <span>Rewrite Engine</span>
            </div>

            <div id="adminNavGroup" style="display:none;">
              <div class="nav-group-label">Admin</div>
              <div id="navAudit" class="nav-item">
                <span class="icon">üìú</span>
                <span>Audit Trail</span>
              </div>
              <div id="navClients" class="nav-item">
                <span class="icon">üë•</span>
                <span>Clients</span>
              </div>
            </div>

            <div class="sidebar-footer">
              Local demo build ¬∑ qwen2.5:7b via Ollama
            </div>
          </aside>

          <!-- Main Content -->
          <main class="content">
            <!-- Rewrite View -->
            <section id="view-rewrite" class="view active">
              <div class="center-wrap">
                <section class="pane pane-left">
                  <div class="section-title">Time Entry</div>

                  <label for="clientSearchInput">Client</label>
                  <div class="searchable-dropdown" id="clientDropdown">
                    <input type="text" id="clientSearchInput" class="search-input" placeholder="Search clients..." readonly>
                    <div class="dropdown-list" id="clientDropdownList"></div>
                  </div>
                  <input type="hidden" id="clientSelect">

                  <label for="hours">Hours</label>
                  <input id="hours" type="number" step="0.1" value="1.5">

                  <label for="original">Original Narrative</label>
                  <textarea id="original" rows="8"
                    placeholder="Reviewed client emails regarding lease dispute and drafted response."></textarea>

                  <label for="rules">Custom Rules (JSON for ‚ÄúRewrite Only‚Äù)</label>
                  <textarea id="rules" rows="5">
{
  "forbidden_terms": ["email review", "miscellaneous"],
  "required_elements": ["Include subject of work"]
}
                  </textarea>

                  <div class="button-row">
                    <button id="runBtn">Rewrite Only</button>
                    <button id="saveBtn" class="secondary">Rewrite &amp; Save</button>
                  </div>
                  <div id="status" class="status"></div>
                </section>

                <section class="pane pane-right">
                  <div class="section-title">Rewrites</div>
                  <div class="output-section">
                    <div class="output-block">
                      <div class="output-title">Standard</div>
                      <pre id="outStandard"></pre>
                    </div>
                    <div class="output-block">
                      <div class="output-title">Client-Compliant</div>
                      <pre id="outClient"></pre>
                    </div>
                    <div class="output-block">
                      <div class="output-title">Audit-Safe</div>
                      <pre id="outAudit"></pre>
                    </div>
                    <div class="output-block">
                      <div class="output-title">Notes</div>
                      <pre id="outNotes"></pre>
                    </div>
                  </div>

                  <div class="grid-bottom">
                    <div>
                      <div class="section-title">
                        Recent Saved Entries
                        <span class="pill-muted">latest</span>
                      </div>
                      <table>
                        <thead>
                          <tr>
                            <th>Client</th>
                            <th>Standard Rewrite</th>
                            <th>Notes</th>
                            <th>Status</th>
                          </tr>
                        </thead>
                        <tbody id="recentTableBody">
                          <!-- rows injected -->
                        </tbody>
                      </table>
                    </div>

                    <div>
                      <div class="section-title">
                        Tips
                        <span class="pill-muted">demo</span>
                      </div>
                      <p class="small">
                        ‚Ä¢ Use <strong>Rewrite Only</strong> to experiment with JSON rules without saving.<br>
                        ‚Ä¢ Use <strong>Rewrite &amp; Save</strong> to log entries and populate the recent table.<br>
                        ‚Ä¢ Admins can add billing guidelines &amp; examples per client in the <strong>Clients</strong> area.
                      </p>
                    </div>
                  </div>
                </section>
              </div>
            </section>

            <!-- Admin Audit View -->
            <section id="view-admin-audit" class="view">
              <div class="center-wrap single">
                <section class="pane" style="flex:1; overflow:hidden;">
                  <div class="section-title">
                    Audit Trail
                    <span class="badge">Admin only</span>
                  </div>
                  <div class="button-row" style="margin-top:6px;">
                    <button id="loadAuditBtn" class="secondary small">Load Audit Log</button>
                  </div>
                  <div style="margin-top:10px; max-height:100%; overflow:auto;">
                    <table>
                      <thead>
                        <tr>
                          <th>When / Who</th>
                          <th>Client &amp; Original</th>
                          <th>Standard Rewrite</th>
                        </tr>
                      </thead>
                      <tbody id="auditTableBody">
                        <!-- rows injected -->
                      </tbody>
                    </table>
                  </div>
                </section>
              </div>
            </section>

            <!-- Admin Clients View -->
            <section id="view-admin-clients" class="view">
              <div class="center-wrap single">
                <section class="pane" style="flex:1; overflow:hidden;">
                  <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-6);">
                    <div class="section-title" style="margin-bottom: 0;">
                      Clients Management
                      <span class="badge">Admin only</span>
                    </div>
                    <button id="adminClientNewBtn" class="small">+ New Client</button>
                  </div>

                  <div style="overflow:auto;">
                    <table>
                      <thead>
                        <tr>
                          <th style="width:15%;">ID</th>
                          <th style="width:30%;">Name</th>
                          <th style="width:15%;">Code</th>
                          <th style="width:25%;">Guidelines</th>
                          <th style="width:15%;">Actions</th>
                        </tr>
                      </thead>
                      <tbody id="adminClientTableBody">
                        <!-- rows injected -->
                      </tbody>
                    </table>
                  </div>

                  <div class="pagination-container" id="clientsPaginationContainer" style="display: none;">
                    <div class="pagination-info" id="clientsPaginationInfo"></div>
                    <div class="pagination-controls">
                      <button class="pagination-btn" id="clientsPagePrev">‚Üê Prev</button>
                      <div id="clientsPageNumbers"></div>
                      <button class="pagination-btn" id="clientsPageNext">Next ‚Üí</button>
                    </div>
                  </div>
                </section>
              </div>
            </section>
          </main>
        </div>
      </div>
    </div>

    <!-- Client Modal -->
    <div id="clientModal" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title" id="modalTitle">New Client</div>
          <button class="modal-close" id="modalCloseBtn">√ó</button>
        </div>
        <div class="modal-body">
          <div class="form-grid">
            <div>
              <label for="modalClientId">Client ID *</label>
              <input id="modalClientId" placeholder="e.g., C004">
            </div>

            <div>
              <label for="modalClientName">Client Name *</label>
              <input id="modalClientName" placeholder="Client Name">
            </div>

            <div>
              <label for="modalClientCode">Client Code</label>
              <input id="modalClientCode" placeholder="Billing code (optional)">
            </div>

            <div>
              <label for="modalClientGuidelines">Billing Guidelines</label>
              <textarea id="modalClientGuidelines" rows="4"
                placeholder="Paste key billing guidelines or a concise summary here..."></textarea>
            </div>

            <div class="upload-section">
              <div class="upload-section-title">üìÑ Upload Guidelines PDF</div>
              <div class="file-input-wrapper">
                <input type="file" id="modalGuidelinesFileInput" accept=".pdf">
              </div>
              <button class="upload-btn" id="modalUploadGuidelinesBtn">Upload & Extract Text</button>
              <div class="upload-hint">Upload a PDF to automatically extract and populate guidelines</div>
            </div>

            <div>
              <label for="modalClientAccepted">Accepted Examples (line-separated)</label>
              <textarea id="modalClientAccepted" rows="3"
                placeholder="Example: Reviewed and analyzed client correspondence regarding lease dispute and prepared summary.&#10;Example: Drafted motion to compel and supporting memorandum."></textarea>
            </div>

            <div class="upload-section">
              <div class="upload-section-title">‚úÖ Upload Accepted Examples PDF</div>
              <div class="file-input-wrapper">
                <input type="file" id="modalAcceptedFileInput" accept=".pdf">
              </div>
              <button class="upload-btn" id="modalUploadAcceptedBtn">Upload & Extract Text</button>
              <div class="upload-hint">Upload a PDF with successful billing examples</div>
            </div>

            <div>
              <label for="modalClientDenied">Denied Examples (line-separated)</label>
              <textarea id="modalClientDenied" rows="3"
                placeholder="Example: emails&#10;Example: work on case"></textarea>
            </div>

            <div class="upload-section">
              <div class="upload-section-title">‚ùå Upload Denied Examples PDF</div>
              <div class="file-input-wrapper">
                <input type="file" id="modalDeniedFileInput" accept=".pdf">
              </div>
              <button class="upload-btn" id="modalUploadDeniedBtn">Upload & Extract Text</button>
              <div class="upload-hint">Upload a PDF with examples of billing entries to avoid</div>
            </div>

            <div id="modalStatus" class="status"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="modalCancelBtn" class="secondary">Cancel</button>
          <button id="modalDeleteBtn" class="danger" style="display: none;">Delete Client</button>
          <button id="modalSaveBtn">Save Client</button>
        </div>
      </div>
    </div>

    <!-- Alert Modal -->
    <div id="alertModal" class="modal-overlay">
      <div class="modal" style="max-width: 500px;">
        <div class="modal-header">
          <div class="modal-title" id="alertModalTitle">Notice</div>
          <button class="modal-close" id="alertModalCloseBtn">√ó</button>
        </div>
        <div class="modal-body">
          <p id="alertModalMessage" style="margin: 0; line-height: 1.6; color: var(--text-primary);"></p>
        </div>
        <div class="modal-footer">
          <button id="alertModalOkBtn">OK</button>
        </div>
      </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal-overlay">
      <div class="modal" style="max-width: 500px;">
        <div class="modal-header">
          <div class="modal-title" id="confirmModalTitle">Confirm</div>
          <button class="modal-close" id="confirmModalCloseBtn">√ó</button>
        </div>
        <div class="modal-body">
          <p id="confirmModalMessage" style="margin: 0; line-height: 1.6; color: var(--text-primary);"></p>
        </div>
        <div class="modal-footer">
          <button id="confirmModalCancelBtn" class="secondary">Cancel</button>
          <button id="confirmModalConfirmBtn">Confirm</button>
        </div>
      </div>
    </div>

    <!-- Prompt Modal -->
    <div id="promptModal" class="modal-overlay">
      <div class="modal" style="max-width: 500px;">
        <div class="modal-header">
          <div class="modal-title" id="promptModalTitle">Input Required</div>
          <button class="modal-close" id="promptModalCloseBtn">√ó</button>
        </div>
        <div class="modal-body">
          <p id="promptModalMessage" style="margin-bottom: var(--space-4); line-height: 1.6; color: var(--text-primary);"></p>
          <input type="text" id="promptModalInput" style="margin-top: 0;">
        </div>
        <div class="modal-footer">
          <button id="promptModalCancelBtn" class="secondary">Cancel</button>
          <button id="promptModalOkBtn">OK</button>
        </div>
      </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingOverlay" class="loading-overlay">
      <div>
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "http://localhost:9001";

    let authToken = null;
    let userRole = null;
    let username = null;

    const loginScreen = document.getElementById("loginScreen");
    const appScreen = document.getElementById("appScreen");

    const loginBtn = document.getElementById("loginBtn");
    const loginStatus = document.getElementById("loginStatus");
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");

    const userLabel = document.getElementById("userLabel");
    const rolePill = document.getElementById("rolePill");
    const logoutLink = document.getElementById("logoutLink");

    const clientSelect = document.getElementById("clientSelect");
    const clientSearchInput = document.getElementById("clientSearchInput");
    const clientDropdownList = document.getElementById("clientDropdownList");
    const clientDropdown = document.getElementById("clientDropdown");
    const hoursInput = document.getElementById("hours");
    const originalInput = document.getElementById("original");
    const rulesInput = document.getElementById("rules");
    const runBtn = document.getElementById("runBtn");
    const saveBtn = document.getElementById("saveBtn");
    const statusEl = document.getElementById("status");

    const outStandard = document.getElementById("outStandard");
    const outClient = document.getElementById("outClient");
    const outAudit = document.getElementById("outAudit");
    const outNotes = document.getElementById("outNotes");

    const recentTableBody = document.getElementById("recentTableBody");

    // Views & nav
    const viewRewrite = document.getElementById("view-rewrite");
    const viewAdminAudit = document.getElementById("view-admin-audit");
    const viewAdminClients = document.getElementById("view-admin-clients");
    const navRewrite = document.getElementById("navRewrite");
    const navAudit = document.getElementById("navAudit");
    const navClients = document.getElementById("navClients");
    const adminNavGroup = document.getElementById("adminNavGroup");

    // Audit view
    const loadAuditBtn = document.getElementById("loadAuditBtn");
    const auditTableBody = document.getElementById("auditTableBody");

    // Admin clients
    const adminClientNewBtn = document.getElementById("adminClientNewBtn");
    const adminClientTableBody = document.getElementById("adminClientTableBody");

    // Modal elements
    const clientModal = document.getElementById("clientModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalCloseBtn = document.getElementById("modalCloseBtn");
    const modalCancelBtn = document.getElementById("modalCancelBtn");
    const modalSaveBtn = document.getElementById("modalSaveBtn");
    const modalDeleteBtn = document.getElementById("modalDeleteBtn");
    const modalClientIdInput = document.getElementById("modalClientId");
    const modalClientNameInput = document.getElementById("modalClientName");
    const modalClientCodeInput = document.getElementById("modalClientCode");
    const modalClientGuidelinesInput = document.getElementById("modalClientGuidelines");
    const modalClientAcceptedInput = document.getElementById("modalClientAccepted");
    const modalClientDeniedInput = document.getElementById("modalClientDenied");
    const modalStatus = document.getElementById("modalStatus");

    let currentEditingClientId = null;
    let allClients = [];
    let selectedClientId = null;

    // Pagination state
    let allAdminClients = [];
    let currentPage = 1;
    const itemsPerPage = 50;

    // ===== Searchable Dropdown Functions =====

    function setupSearchableDropdown() {
      // Toggle dropdown on input click
      clientSearchInput.addEventListener('click', (e) => {
        e.stopPropagation();
        const isActive = clientDropdownList.classList.contains('active');
        if (isActive) {
          clientDropdownList.classList.remove('active');
        } else {
          clientSearchInput.readOnly = false;
          clientSearchInput.select();
          renderDropdownItems(allClients);
          clientDropdownList.classList.add('active');
        }
      });

      // Filter on input
      clientSearchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filtered = allClients.filter(c =>
          c.name.toLowerCase().includes(searchTerm) ||
          c.id.toLowerCase().includes(searchTerm)
        );
        renderDropdownItems(filtered);
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!clientDropdown.contains(e.target)) {
          clientDropdownList.classList.remove('active');
          clientSearchInput.readOnly = true;
          // Restore selected client name if there is one
          if (selectedClientId) {
            const client = allClients.find(c => c.id === selectedClientId);
            if (client) {
              clientSearchInput.value = `${client.name} (${client.id})`;
            }
          } else {
            clientSearchInput.value = '';
            clientSearchInput.placeholder = 'Search clients...';
          }
        }
      });
    }

    function renderDropdownItems(clients) {
      clientDropdownList.innerHTML = '';

      if (!clients.length) {
        const noResults = document.createElement('div');
        noResults.className = 'dropdown-item no-results';
        noResults.textContent = 'No clients found';
        clientDropdownList.appendChild(noResults);
        return;
      }

      clients.forEach(client => {
        const item = document.createElement('div');
        item.className = 'dropdown-item';
        if (client.id === selectedClientId) {
          item.classList.add('selected');
        }
        item.textContent = `${client.name} (${client.id})`;
        item.dataset.clientId = client.id;

        item.addEventListener('click', (e) => {
          e.stopPropagation();
          selectClient(client);
        });

        clientDropdownList.appendChild(item);
      });
    }

    function selectClient(client) {
      selectedClientId = client.id;
      clientSelect.value = client.id;
      clientSearchInput.value = `${client.name} (${client.id})`;
      clientSearchInput.readOnly = true;
      clientDropdownList.classList.remove('active');
    }

    // ===== Pagination Functions =====

    function renderPaginatedClients() {
      const totalPages = Math.ceil(allAdminClients.length / itemsPerPage);
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = Math.min(startIndex + itemsPerPage, allAdminClients.length);
      const pageClients = allAdminClients.slice(startIndex, endIndex);

      // Render table rows
      adminClientTableBody.innerHTML = "";

      if (!allAdminClients.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="5" style="text-align: center; color: var(--text-tertiary);">No clients yet. Click "New Client" to add one.</td>`;
        adminClientTableBody.appendChild(tr);
        document.getElementById('clientsPaginationContainer').style.display = 'none';
        return;
      }

      for (const c of pageClients) {
        const tr = document.createElement("tr");
        const guidelinesPreview = c.billing_guidelines
          ? (c.billing_guidelines.substring(0, 50) + (c.billing_guidelines.length > 50 ? "..." : ""))
          : "-";

        tr.innerHTML = `
          <td>${c.id}</td>
          <td>${c.name}</td>
          <td>${c.code || "-"}</td>
          <td>${guidelinesPreview}</td>
          <td>
            <button class="action-btn" onclick="editClient('${c.id}')">‚úèÔ∏è Edit</button>
            <button class="action-btn danger" onclick="deleteClient('${c.id}')">üóëÔ∏è Delete</button>
          </td>
        `;
        adminClientTableBody.appendChild(tr);
      }

      // Update pagination controls
      if (totalPages > 1) {
        document.getElementById('clientsPaginationContainer').style.display = 'flex';

        // Update info
        const paginationInfo = document.getElementById('clientsPaginationInfo');
        paginationInfo.textContent = `Showing ${startIndex + 1}-${endIndex} of ${allAdminClients.length} clients`;

        // Update buttons
        const prevBtn = document.getElementById('clientsPagePrev');
        const nextBtn = document.getElementById('clientsPageNext');
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages;

        // Render page numbers
        const pageNumbersContainer = document.getElementById('clientsPageNumbers');
        pageNumbersContainer.innerHTML = '';

        // Show max 7 page numbers: 1 ... 4 5 6 ... 10
        const maxPageButtons = 7;
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, currentPage + 2);

        if (currentPage <= 3) {
          endPage = Math.min(5, totalPages);
        }
        if (currentPage >= totalPages - 2) {
          startPage = Math.max(1, totalPages - 4);
        }

        if (startPage > 1) {
          addPageButton(1);
          if (startPage > 2) {
            const ellipsis = document.createElement('span');
            ellipsis.textContent = '...';
            ellipsis.style.padding = '0 var(--space-2)';
            ellipsis.style.color = 'var(--text-tertiary)';
            pageNumbersContainer.appendChild(ellipsis);
          }
        }

        for (let i = startPage; i <= endPage; i++) {
          addPageButton(i);
        }

        if (endPage < totalPages) {
          if (endPage < totalPages - 1) {
            const ellipsis = document.createElement('span');
            ellipsis.textContent = '...';
            ellipsis.style.padding = '0 var(--space-2)';
            ellipsis.style.color = 'var(--text-tertiary)';
            pageNumbersContainer.appendChild(ellipsis);
          }
          addPageButton(totalPages);
        }
      } else {
        document.getElementById('clientsPaginationContainer').style.display = 'none';
      }
    }

    function addPageButton(pageNum) {
      const pageNumbersContainer = document.getElementById('clientsPageNumbers');
      const btn = document.createElement('button');
      btn.className = 'pagination-btn';
      if (pageNum === currentPage) {
        btn.classList.add('active');
      }
      btn.textContent = pageNum;
      btn.onclick = () => {
        currentPage = pageNum;
        renderPaginatedClients();
      };
      pageNumbersContainer.appendChild(btn);
    }

    function setupPagination() {
      document.getElementById('clientsPagePrev').addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          renderPaginatedClients();
        }
      });

      document.getElementById('clientsPageNext').addEventListener('click', () => {
        const totalPages = Math.ceil(allAdminClients.length / itemsPerPage);
        if (currentPage < totalPages) {
          currentPage++;
          renderPaginatedClients();
        }
      });
    }

    // ===== Input Validation Functions =====

    function validateRequired(value, fieldName) {
      if (!value || value.trim() === '') {
        return `${fieldName} is required`;
      }
      return null;
    }

    function validateEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        return 'Invalid email format';
      }
      return null;
    }

    function validateClientId(clientId) {
      if (!clientId) {
        return 'Client ID is required';
      }
      if (clientId.length < 2 || clientId.length > 20) {
        return 'Client ID must be between 2 and 20 characters';
      }
      if (!/^[A-Za-z0-9_-]+$/.test(clientId)) {
        return 'Client ID can only contain letters, numbers, hyphens, and underscores';
      }
      return null;
    }

    function validateHours(hours) {
      const hoursNum = parseFloat(hours);
      if (isNaN(hoursNum)) {
        return 'Hours must be a number';
      }
      if (hoursNum < 0) {
        return 'Hours cannot be negative';
      }
      if (hoursNum > 24) {
        return 'Hours cannot exceed 24 per entry';
      }
      return null;
    }

    function showFieldError(fieldElement, errorMessage) {
      // Remove existing error
      const existingError = fieldElement.parentElement.querySelector('.field-error');
      if (existingError) {
        existingError.remove();
      }

      if (errorMessage) {
        // Add error message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'field-error';
        errorDiv.textContent = errorMessage;
        errorDiv.style.color = 'var(--danger)';
        errorDiv.style.fontSize = '13px';
        errorDiv.style.marginTop = 'var(--space-1)';
        errorDiv.style.fontWeight = '500';
        fieldElement.parentElement.insertBefore(errorDiv, fieldElement.nextSibling);

        // Add error styling to field
        fieldElement.style.borderColor = 'var(--danger)';
      } else {
        // Remove error styling
        fieldElement.style.borderColor = '';
      }
    }

    function validateForm(fields) {
      let isValid = true;
      fields.forEach(({ element, validator, fieldName }) => {
        const error = validator(element.value, fieldName);
        showFieldError(element, error);
        if (error) {
          isValid = false;
        }
      });
      return isValid;
    }

    // ===== Loading Spinner Functions =====

    function showLoading(message = 'Loading...') {
      const loadingOverlay = document.getElementById('loadingOverlay');
      const loadingText = document.getElementById('loadingText');
      loadingText.textContent = message;
      loadingOverlay.classList.add('active');
    }

    function hideLoading() {
      const loadingOverlay = document.getElementById('loadingOverlay');
      loadingOverlay.classList.remove('active');
    }

    // ===== Modern Dialog Functions =====

    // Alert Dialog
    function showAlert(message, title = 'Notice') {
      return new Promise((resolve) => {
        const alertModal = document.getElementById('alertModal');
        const alertModalTitle = document.getElementById('alertModalTitle');
        const alertModalMessage = document.getElementById('alertModalMessage');
        const alertModalOkBtn = document.getElementById('alertModalOkBtn');
        const alertModalCloseBtn = document.getElementById('alertModalCloseBtn');

        alertModalTitle.textContent = title;
        alertModalMessage.textContent = message;
        alertModal.classList.add('active');

        const cleanup = () => {
          alertModal.classList.remove('active');
          alertModalOkBtn.removeEventListener('click', handleOk);
          alertModalCloseBtn.removeEventListener('click', handleOk);
          resolve();
        };

        const handleOk = () => cleanup();

        alertModalOkBtn.addEventListener('click', handleOk);
        alertModalCloseBtn.addEventListener('click', handleOk);
      });
    }

    // Confirm Dialog
    function showConfirm(message, title = 'Confirm') {
      return new Promise((resolve) => {
        const confirmModal = document.getElementById('confirmModal');
        const confirmModalTitle = document.getElementById('confirmModalTitle');
        const confirmModalMessage = document.getElementById('confirmModalMessage');
        const confirmModalConfirmBtn = document.getElementById('confirmModalConfirmBtn');
        const confirmModalCancelBtn = document.getElementById('confirmModalCancelBtn');
        const confirmModalCloseBtn = document.getElementById('confirmModalCloseBtn');

        confirmModalTitle.textContent = title;
        confirmModalMessage.textContent = message;
        confirmModal.classList.add('active');

        const cleanup = (result) => {
          confirmModal.classList.remove('active');
          confirmModalConfirmBtn.removeEventListener('click', handleConfirm);
          confirmModalCancelBtn.removeEventListener('click', handleCancel);
          confirmModalCloseBtn.removeEventListener('click', handleCancel);
          resolve(result);
        };

        const handleConfirm = () => cleanup(true);
        const handleCancel = () => cleanup(false);

        confirmModalConfirmBtn.addEventListener('click', handleConfirm);
        confirmModalCancelBtn.addEventListener('click', handleCancel);
        confirmModalCloseBtn.addEventListener('click', handleCancel);
      });
    }

    // Prompt Dialog
    function showPrompt(message, title = 'Input Required', defaultValue = '') {
      return new Promise((resolve) => {
        const promptModal = document.getElementById('promptModal');
        const promptModalTitle = document.getElementById('promptModalTitle');
        const promptModalMessage = document.getElementById('promptModalMessage');
        const promptModalInput = document.getElementById('promptModalInput');
        const promptModalOkBtn = document.getElementById('promptModalOkBtn');
        const promptModalCancelBtn = document.getElementById('promptModalCancelBtn');
        const promptModalCloseBtn = document.getElementById('promptModalCloseBtn');

        promptModalTitle.textContent = title;
        promptModalMessage.textContent = message;
        promptModalInput.value = defaultValue;
        promptModal.classList.add('active');

        // Focus input after a brief delay to ensure modal is visible
        setTimeout(() => promptModalInput.focus(), 100);

        const cleanup = (result) => {
          promptModal.classList.remove('active');
          promptModalOkBtn.removeEventListener('click', handleOk);
          promptModalCancelBtn.removeEventListener('click', handleCancel);
          promptModalCloseBtn.removeEventListener('click', handleCancel);
          promptModalInput.removeEventListener('keypress', handleKeyPress);
          resolve(result);
        };

        const handleOk = () => {
          const value = promptModalInput.value.trim();
          cleanup(value || null);
        };

        const handleCancel = () => cleanup(null);

        const handleKeyPress = (e) => {
          if (e.key === 'Enter') {
            handleOk();
          }
        };

        promptModalOkBtn.addEventListener('click', handleOk);
        promptModalCancelBtn.addEventListener('click', handleCancel);
        promptModalCloseBtn.addEventListener('click', handleCancel);
        promptModalInput.addEventListener('keypress', handleKeyPress);
      });
    }

    function buildAuthHeaders(base = {}) {
      const headers = { ...base };
      if (authToken) {
        headers["Authorization"] = "Bearer " + authToken;
      }
      return headers;
    }

    function showLoginStatus(message, isError = false) {
      loginStatus.textContent = message;
      loginStatus.classList.toggle("error", isError);
    }

    function switchToApp() {
      loginScreen.style.display = "none";
      appScreen.style.display = "flex";
    }

    function switchToLogin() {
      authToken = null;
      userRole = null;
      username = null;
      appScreen.style.display = "none";
      loginScreen.style.display = "flex";
      showLoginStatus("", false);
      statusEl.textContent = "";
      outStandard.textContent = "";
      outClient.textContent = "";
      outAudit.textContent = "";
      outNotes.textContent = "";
      setActiveView("rewrite");
    }

    function setActiveView(view) {
      // Views
      viewRewrite.classList.remove("active");
      viewAdminAudit.classList.remove("active");
      viewAdminClients.classList.remove("active");

      if (view === "rewrite") {
        viewRewrite.classList.add("active");
      } else if (view === "audit") {
        viewAdminAudit.classList.add("active");
      } else if (view === "clients") {
        viewAdminClients.classList.add("active");
      }

      // Nav
      navRewrite.classList.remove("active");
      navAudit.classList.remove("active");
      navClients.classList.remove("active");

      if (view === "rewrite") {
        navRewrite.classList.add("active");
      } else if (view === "audit") {
        navAudit.classList.add("active");
      } else if (view === "clients") {
        navClients.classList.add("active");
      }
    }

    async function login() {
      const u = usernameInput.value.trim();
      const p = passwordInput.value;

      if (!u || !p) {
        showLoginStatus("Enter username and password.", true);
        return;
      }

      showLoading('Authenticating...');
      try {
        const res = await fetch(`${API_BASE}/auth/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username: u, password: p })
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || `HTTP ${res.status}`);
        }

        const data = await res.json();
        authToken = data.access_token;
        userRole = data.role;
        username = data.username;

        userLabel.textContent = "@" + username;
        rolePill.textContent = userRole;
        rolePill.classList.toggle("admin", userRole === "admin");

        adminNavGroup.style.display = userRole === "admin" ? "block" : "none";

        showLoginStatus("");
        statusEl.textContent = "Authenticated. You can now rewrite and save.";
        switchToApp();

        setActiveView("rewrite");
        loadClients();
        loadRecentEntries();
        if (userRole === "admin") {
          loadAdminClients();
        }
      } catch (err) {
        console.error(err);
        showLoginStatus("Login failed: " + err.message, true);
      } finally {
        hideLoading();
      }
    }

    async function loadClients() {
      try {
        const res = await fetch(`${API_BASE}/clients/`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const clients = await res.json();

        allClients = clients;
        selectedClientId = null;
        clientSelect.value = '';
        clientSearchInput.value = '';
        clientSearchInput.placeholder = 'Search clients...';
        renderDropdownItems(clients);
      } catch (err) {
        console.error(err);
        clientSearchInput.value = '';
        clientSearchInput.placeholder = 'Error loading clients';
        allClients = [];
      }
    }

    async function loadRecentEntries() {
      try {
        const res = await fetch(`${API_BASE}/rewrites/recent?limit=20`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const rows = await res.json();

        recentTableBody.innerHTML = "";
        if (!rows.length) {
          recentTableBody.innerHTML = `<tr><td colspan="4">No saved entries yet.</td></tr>`;
          return;
        }

        for (const row of rows) {
          const tr = document.createElement("tr");
          const statusBadge = getStatusBadge(row.rewrite.status || "not_submitted");
          const buttons = row.rewrite.status === "not_submitted"
            ? `<button onclick="tagRewrite('${row.rewrite_id}', 'success')" class="btn-tag btn-success">‚úì</button>
               <button onclick="tagRewrite('${row.rewrite_id}', 'failure')" class="btn-tag btn-failure">‚úó</button>`
            : '';

          tr.innerHTML = `
            <td>${row.client.name}</td>
            <td>${row.rewrite.standard || ""}</td>
            <td>${row.rewrite.notes || ""}</td>
            <td>${statusBadge} ${buttons}</td>
          `;
          recentTableBody.appendChild(tr);
        }
      } catch (err) {
        console.error(err);
        recentTableBody.innerHTML = `<tr><td colspan="4">Error loading recent entries</td></tr>`;
      }
    }

    function getStatusBadge(status) {
      if (status === "success") {
        return '<span class="badge-success">‚úì Success</span>';
      } else if (status === "failure") {
        return '<span class="badge-failure">‚úó Failure</span>';
      } else {
        return '<span class="badge-pending">‚óã Not Submitted</span>';
      }
    }

    async function tagRewrite(rewriteId, status) {
      const variant = await showPrompt(
        'Which variant was used?\n1. standard\n2. client_compliant\n3. audit_safe\n\nEnter 1, 2, or 3:',
        'Select Variant'
      );
      const variantMap = {'1': 'standard', '2': 'client_compliant', '3': 'audit_safe'};
      const selectedVariant = variantMap[variant];

      if (!selectedVariant) {
        await showAlert('Invalid selection');
        return;
      }

      const notes = await showPrompt('Optional feedback notes:', 'Feedback');

      try {
        const res = await fetch(API_BASE + '/rewrites/' + rewriteId + '/tag', {
          method: 'PATCH',
          headers: buildAuthHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify({
            status: status,
            selected_variant: selectedVariant,
            feedback_notes: notes || undefined
          }),
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error ? err.error.message : 'HTTP ' + res.status);
        }

        const result = await res.json();
        await showAlert(
          'Tagged as ' + status + '! ' + (result.auto_ingested ? 'Auto-ingested into client examples.' : ''),
          'Success'
        );
        loadRecentEntries();
      } catch (err) {
        console.error(err);
        await showAlert('Failed to tag rewrite: ' + err.message, 'Error');
      }
    }

    async function loadAuditLog() {
      if (!authToken || userRole !== "admin") {
        return;
      }

      showLoading('Loading audit log...');
      try {
        const res = await fetch(`${API_BASE}/admin/audit-events?limit=50`, {
          headers: buildAuthHeaders(),
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || `HTTP ${res.status}`);
        }

        const rows = await res.json();
        auditTableBody.innerHTML = "";

        if (!rows.length) {
          auditTableBody.innerHTML = `<tr><td colspan="3">No audit events yet.</td></tr>`;
          return;
        }

        for (const row of rows) {
          const when = new Date(row.timestamp).toLocaleString();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>
              <div><strong>${row.username}</strong> <span class="badge">${row.role}</span></div>
              <div class="small">${when}</div>
            </td>
            <td>
              <div><strong>${row.client.name}</strong></div>
              <div class="small">${row.original}</div>
            </td>
            <td>
              <div>${row.standard}</div>
            </td>
          `;
          auditTableBody.appendChild(tr);
        }
      } catch (err) {
        console.error(err);
        auditTableBody.innerHTML = `<tr><td colspan="3" class="badge-danger">Error loading audit log: ${err.message}</td></tr>`;
      } finally {
        hideLoading();
      }
    }

    async function rewriteOnly() {
      if (!authToken) {
        statusEl.textContent = "Please log in first.";
        return;
      }

      const original = originalInput.value.trim();
      const hours = parseFloat(hoursInput.value || "0");

      if (!original) {
        statusEl.textContent = "Please enter an original narrative.";
        return;
      }

      let rules = null;
      const rulesText = rulesInput.value.trim();
      if (rulesText) {
        try {
          rules = JSON.parse(rulesText);
        } catch (e) {
          statusEl.textContent = "Rules JSON is invalid.";
          return;
        }
      }

      statusEl.textContent = "Rewriting...";
      outStandard.textContent = "";
      outClient.textContent = "";
      outAudit.textContent = "";
      outNotes.textContent = "";

      showLoading('Rewriting narrative...');
      try {
        const res = await fetch(`${API_BASE}/rewrites/rewrite`, {
          method: "POST",
          headers: buildAuthHeaders({ "Content-Type": "application/json" }),
          body: JSON.stringify({
            original,
            hours,
            rules
          })
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || `HTTP ${res.status}`);
        }

        const data = await res.json();
        outStandard.textContent = data.standard || "";
        outClient.textContent = data.client_compliant || "";
        outAudit.textContent = data.audit_safe || "";
        outNotes.textContent = data.notes || "";
        statusEl.textContent = "Rewrite complete.";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error: " + err.message;
      } finally {
        hideLoading();
      }
    }

    async function rewriteAndSave() {
      if (!authToken) {
        statusEl.textContent = "Please log in first.";
        return;
      }

      const original = originalInput.value.trim();
      const hours = parseFloat(hoursInput.value || "0");
      const clientId = clientSelect.value;

      // Validate fields
      let hasErrors = false;

      if (!clientId) {
        statusEl.textContent = "Please select a client.";
        return;
      }

      if (!original) {
        showFieldError(originalInput, 'Original narrative is required');
        hasErrors = true;
      } else {
        showFieldError(originalInput, null);
      }

      const hoursError = validateHours(hoursInput.value);
      showFieldError(hoursInput, hoursError);
      if (hoursError) {
        hasErrors = true;
      }

      if (hasErrors) {
        statusEl.textContent = "Please fix validation errors above.";
        return;
      }

      statusEl.textContent = "Rewriting and saving...";
      outStandard.textContent = "";
      outClient.textContent = "";
      outAudit.textContent = "";
      outNotes.textContent = "";

      showLoading('Rewriting and saving...');
      try {
        const res = await fetch(`${API_BASE}/rewrites/rewrite-and-save`, {
          method: "POST",
          headers: buildAuthHeaders({ "Content-Type": "application/json" }),
          body: JSON.stringify({
            client_id: clientId,
            original,
            hours
          })
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || `HTTP ${res.status}`);
        }

        const data = await res.json();
        outStandard.textContent = data.rewrite.standard || "";
        outClient.textContent = data.rewrite.client_compliant || "";
        outAudit.textContent = data.rewrite.audit_safe || "";
        outNotes.textContent = data.rewrite.notes || "";
        statusEl.textContent = "Rewrite saved.";
        loadRecentEntries();
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error: " + err.message;
      } finally {
        hideLoading();
      }
    }

    // ===== Admin Clients UI =====

    // Modal functions
    function openClientModal(clientData = null) {
      if (clientData) {
        // Edit mode
        modalTitle.textContent = "Edit Client";
        modalClientIdInput.value = clientData.id;
        modalClientIdInput.disabled = true;
        modalClientNameInput.value = clientData.name || "";
        modalClientCodeInput.value = clientData.code || "";
        modalClientGuidelinesInput.value = clientData.billing_guidelines || "";
        modalClientAcceptedInput.value = clientData.accepted_examples || "";
        modalClientDeniedInput.value = clientData.denied_examples || "";
        modalDeleteBtn.style.display = "block";
        currentEditingClientId = clientData.id;
      } else {
        // New mode
        modalTitle.textContent = "New Client";
        modalClientIdInput.value = "";
        modalClientIdInput.disabled = false;
        modalClientNameInput.value = "";
        modalClientCodeInput.value = "";
        modalClientGuidelinesInput.value = "";
        modalClientAcceptedInput.value = "";
        modalClientDeniedInput.value = "";
        modalDeleteBtn.style.display = "none";
        currentEditingClientId = null;
      }
      modalStatus.textContent = "";
      clientModal.classList.add("active");
    }

    function closeClientModal() {
      clientModal.classList.remove("active");
      currentEditingClientId = null;
    }

    async function loadAdminClients() {
      if (!authToken || userRole !== "admin") {
        return;
      }
      try {
        const res = await fetch(`${API_BASE}/admin/clients`, {
          headers: buildAuthHeaders(),
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || `HTTP ${res.status}`);
        }

        const clients = await res.json();
        allAdminClients = clients;
        currentPage = 1;
        renderPaginatedClients();
      } catch (err) {
        console.error(err);
        adminClientTableBody.innerHTML = `<tr><td colspan="5">Error loading clients: ${err.message}</td></tr>`;
        document.getElementById('clientsPaginationContainer').style.display = 'none';
      }
    }

    async function editClient(clientId) {
      try {
        const res = await fetch(`${API_BASE}/admin/clients`, {
          headers: buildAuthHeaders(),
        });
        const clients = await res.json();
        const client = clients.find(c => c.id === clientId);
        if (client) {
          openClientModal(client);
        }
      } catch (err) {
        console.error(err);
        await showAlert("Error loading client: " + err.message, 'Error');
      }
    }

    async function deleteClient(clientId) {
      const confirmed = await showConfirm(
        `Delete client ${clientId}? This cannot be undone.`,
        'Delete Client'
      );

      if (!confirmed) {
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/admin/clients/${encodeURIComponent(clientId)}`, {
          method: "DELETE",
          headers: buildAuthHeaders(),
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || `HTTP ${res.status}`);
        }

        await showAlert("Client deleted successfully", 'Success');
        loadClients();
        loadAdminClients();
      } catch (err) {
        console.error(err);
        await showAlert("Error deleting client: " + err.message, 'Error');
      }
    }

    async function saveModalClient() {
      if (!authToken || userRole !== "admin") {
        modalStatus.textContent = "Admin login required.";
        return;
      }

      const id = modalClientIdInput.value.trim();
      const name = modalClientNameInput.value.trim();
      const code = modalClientCodeInput.value.trim();
      const guidelines = modalClientGuidelinesInput.value.trim();
      const accepted = modalClientAcceptedInput.value.trim();
      const denied = modalClientDeniedInput.value.trim();

      // Validate fields
      const isValid = validateForm([
        { element: modalClientIdInput, validator: validateClientId, fieldName: 'Client ID' },
        { element: modalClientNameInput, validator: validateRequired, fieldName: 'Client Name' }
      ]);

      if (!isValid) {
        modalStatus.textContent = "Please fix validation errors above.";
        return;
      }

      const payload = {
        name,
        code: code || null,
        billing_guidelines: guidelines || null,
        accepted_examples: accepted || null,
        denied_examples: denied || null,
      };

      modalStatus.textContent = "Saving client...";
      showLoading('Saving client...');
      try {
        let res;
        if (currentEditingClientId) {
          // Update existing client
          res = await fetch(`${API_BASE}/admin/clients/${encodeURIComponent(id)}`, {
            method: "PUT",
            headers: buildAuthHeaders({ "Content-Type": "application/json" }),
            body: JSON.stringify(payload),
          });
        } else {
          // Create new client
          res = await fetch(`${API_BASE}/admin/clients`, {
            method: "POST",
            headers: buildAuthHeaders({ "Content-Type": "application/json" }),
            body: JSON.stringify({ id, ...payload }),
          });
        }

        // If client doesn't exist yet during update, fallback to POST create
        if (res.status === 404 && currentEditingClientId) {
          res = await fetch(`${API_BASE}/admin/clients`, {
            method: "POST",
            headers: buildAuthHeaders({ "Content-Type": "application/json" }),
            body: JSON.stringify({ id, ...payload }),
          });
        }

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || `HTTP ${res.status}`);
        }

        modalStatus.textContent = currentEditingClientId ? "Client updated!" : "Client created!";
        setTimeout(() => {
          closeClientModal();
          loadClients();
          loadAdminClients();
        }, 1000);
      } catch (err) {
        console.error(err);
        modalStatus.textContent = "Error: " + err.message;
      } finally {
        hideLoading();
      }
    }

    async function deleteModalClient() {
      if (!currentEditingClientId) {
        return;
      }

      const confirmed = await showConfirm(
        `Delete client ${currentEditingClientId}? This cannot be undone.`,
        'Delete Client'
      );

      if (!confirmed) {
        return;
      }

      try {
        modalStatus.textContent = "Deleting client...";
        const res = await fetch(`${API_BASE}/admin/clients/${encodeURIComponent(currentEditingClientId)}`, {
          method: "DELETE",
          headers: buildAuthHeaders(),
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || `HTTP ${res.status}`);
        }

        modalStatus.textContent = "Client deleted!";
        setTimeout(() => {
          closeClientModal();
          loadClients();
          loadAdminClients();
        }, 1000);
      } catch (err) {
        console.error(err);
        modalStatus.textContent = "Error: " + err.message;
      }
    }

    // Make functions globally accessible for onclick handlers
    window.editClient = editClient;
    window.deleteClient = deleteClient;
    window.tagRewrite = tagRewrite;

    // ===== PDF Upload Functions =====

    async function uploadPDF(endpoint, fileInputId, textareaId) {
      if (!authToken || userRole !== "admin") {
        modalStatus.textContent = "Admin login required.";
        return;
      }

      const clientId = modalClientIdInput.value.trim();
      if (!clientId) {
        modalStatus.textContent = "Please enter a client ID first.";
        return;
      }

      const fileInput = document.getElementById(fileInputId);
      const file = fileInput.files[0];

      if (!file) {
        modalStatus.textContent = "Please select a PDF file first.";
        return;
      }

      if (!file.name.toLowerCase().endsWith('.pdf')) {
        modalStatus.textContent = "Please select a PDF file.";
        return;
      }

      const formData = new FormData();
      formData.append('file', file);

      modalStatus.textContent = `Uploading ${file.name} and extracting text...`;
      showLoading('Uploading and extracting PDF...');
      try {
        const res = await fetch(`${API_BASE}/admin/clients/${encodeURIComponent(clientId)}/${endpoint}`, {
          method: 'POST',
          headers: buildAuthHeaders(),
          body: formData
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || `HTTP ${res.status}`);
        }

        const data = await res.json();
        const textarea = document.getElementById(textareaId);

        // Get the full extracted text from the database by reloading the client
        const clientRes = await fetch(`${API_BASE}/admin/clients`, {
          headers: buildAuthHeaders(),
        });

        if (clientRes.ok) {
          const clients = await clientRes.json();
          const updatedClient = clients.find(c => c.id === clientId);
          if (updatedClient) {
            if (textareaId === 'modalClientGuidelines') {
              textarea.value = updatedClient.billing_guidelines || '';
            } else if (textareaId === 'modalClientAccepted') {
              textarea.value = updatedClient.accepted_examples || '';
            } else if (textareaId === 'modalClientDenied') {
              textarea.value = updatedClient.denied_examples || '';
            }
          }
        }

        modalStatus.textContent = data.message || "PDF text extracted successfully!";
        fileInput.value = ''; // Clear file input
      } catch (err) {
        console.error(err);
        modalStatus.textContent = "Error uploading PDF: " + err.message;
      } finally {
        hideLoading();
      }
    }

    // ---- Event wiring ----
    loginBtn.addEventListener("click", login);
    runBtn.addEventListener("click", rewriteOnly);
    saveBtn.addEventListener("click", rewriteAndSave);
    logoutLink.addEventListener("click", switchToLogin);

    navRewrite.addEventListener("click", () => {
      setActiveView("rewrite");
    });

    navAudit.addEventListener("click", () => {
      if (userRole !== "admin") return;
      setActiveView("audit");
      loadAuditLog();
    });

    navClients.addEventListener("click", () => {
      if (userRole !== "admin") return;
      setActiveView("clients");
      loadAdminClients();
    });

    loadAuditBtn.addEventListener("click", loadAuditLog);

    // Modal event listeners
    adminClientNewBtn.addEventListener("click", () => openClientModal());
    modalCloseBtn.addEventListener("click", closeClientModal);
    modalCancelBtn.addEventListener("click", closeClientModal);
    modalSaveBtn.addEventListener("click", saveModalClient);
    modalDeleteBtn.addEventListener("click", deleteModalClient);

    // Close modal when clicking outside
    clientModal.addEventListener("click", (e) => {
      if (e.target === clientModal) {
        closeClientModal();
      }
    });

    // PDF Upload event listeners (modal)
    document.getElementById("modalUploadGuidelinesBtn").addEventListener("click", () => {
      uploadPDF("upload-guidelines", "modalGuidelinesFileInput", "modalClientGuidelines");
    });
    document.getElementById("modalUploadAcceptedBtn").addEventListener("click", () => {
      uploadPDF("upload-accepted-examples", "modalAcceptedFileInput", "modalClientAccepted");
    });
    document.getElementById("modalUploadDeniedBtn").addEventListener("click", () => {
      uploadPDF("upload-denied-examples", "modalDeniedFileInput", "modalClientDenied");
    });

    // Setup real-time validation
    function setupRealtimeValidation() {
      // Hours validation
      hoursInput.addEventListener('blur', () => {
        const error = validateHours(hoursInput.value);
        showFieldError(hoursInput, error);
      });

      // Client modal validation
      modalClientIdInput.addEventListener('blur', () => {
        if (!currentEditingClientId) { // Only validate ID when creating
          const error = validateClientId(modalClientIdInput.value);
          showFieldError(modalClientIdInput, error);
        }
      });

      modalClientNameInput.addEventListener('blur', () => {
        const error = validateRequired(modalClientNameInput.value, 'Client Name');
        showFieldError(modalClientNameInput, error);
      });

      // Clear errors on input
      [hoursInput, modalClientIdInput, modalClientNameInput, originalInput].forEach(input => {
        input.addEventListener('input', () => {
          // Only clear error if there is one
          const existingError = input.parentElement.querySelector('.field-error');
          if (existingError) {
            showFieldError(input, null);
          }
        });
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      setupSearchableDropdown();
      setupPagination();
      setupRealtimeValidation();
    });
  </script>
</body>
</html>
