<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ai.mdwcg - Legal Billing</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      /* RICOCHET 360 Color Palette */
      --shell-bg: #f5f7fb;
      --app-bg: #ffffff;
      --sidebar-bg: #0f2c4d;        /* Deep navy blue */
      --sidebar-bg-hover: #1a3a5f;
      --sidebar-border: #0a1f38;
      --accent: #3b82f6;             /* Modern blue */
      --accent-soft: rgba(59, 130, 246, 0.08);
      --accent-strong: #2563eb;
      --border-soft: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --success: #16a34a;
      --success-bg: #dcfce7;
      --danger: #dc2626;
      --danger-bg: #fee2e2;
      --warning: #f59e0b;
      --warning-bg: #fef3c7;
      --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
      --card-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--shell-bg);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
    }

    .root {
      flex: 1;
      display: flex;
    }

    /* ========== LOGIN SCREEN ========== */

    #loginScreen {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .login-card {
      width: 100%;
      max-width: 440px;
      background: var(--app-bg);
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      border: 1px solid var(--border-soft);
    }

    .login-brand {
      text-align: center;
      margin-bottom: 24px;
    }

    .login-logo {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      border-radius: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 700;
      color: white;
      margin-bottom: 12px;
    }

    .login-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 4px;
    }

    .login-subtitle {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 24px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-main);
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      padding: 10px 14px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      background: var(--app-bg);
      color: var(--text-main);
      font-size: 14px;
      outline: none;
      transition: all 0.2s;
    }

    .form-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }

    .btn {
      width: 100%;
      padding: 12px 24px;
      border-radius: 6px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
    }

    .login-hint {
      margin-top: 16px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 6px;
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.6;
    }

    .login-hint code {
      background: #e5e7eb;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: "SF Mono", Menlo, Consolas, monospace;
      font-size: 11px;
    }

    .login-status {
      margin-top: 12px;
      font-size: 13px;
      min-height: 18px;
      color: var(--danger);
    }

    /* ========== APP LAYOUT ========== */

    #appScreen {
      flex: 1;
      display: none;
      flex-direction: column;
    }

    .app-header {
      background: var(--app-bg);
      border-bottom: 1px solid var(--border-soft);
      padding: 0 24px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }

    .app-header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .app-logo {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 700;
      color: white;
    }

    .app-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-main);
    }

    .app-title-sub {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 400;
    }

    .app-header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 16px;
      background: #f9fafb;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
    }

    .user-info {
      display: flex;
      flex-direction: column;
    }

    .user-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-main);
    }

    .user-role {
      font-size: 11px;
      color: var(--text-muted);
    }

    .logout-btn {
      padding: 6px 12px;
      background: transparent;
      border: 1px solid var(--border-soft);
      border-radius: 6px;
      color: var(--text-muted);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      background: #f9fafb;
      border-color: #d1d5db;
    }

    .app-body {
      flex: 1;
      display: flex;
      min-height: 0;
    }

    /* ========== SIDEBAR ========== */

    .sidebar {
      width: 240px;
      background: var(--sidebar-bg);
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      padding: 24px 12px;
      gap: 8px;
    }

    .nav-section {
      margin-bottom: 16px;
    }

    .nav-section-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #94a3b8;
      padding: 0 12px;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      color: #cbd5e1;
      transition: all 0.2s;
      font-weight: 500;
    }

    .nav-item:hover {
      background: var(--sidebar-bg-hover);
      color: white;
    }

    .nav-item.active {
      background: var(--accent);
      color: white;
    }

    .nav-icon {
      font-size: 18px;
      width: 20px;
      text-align: center;
    }

    .sidebar-footer {
      margin-top: auto;
      padding: 12px;
      font-size: 11px;
      color: #64748b;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      margin-top: 24px;
    }

    /* ========== MAIN CONTENT ========== */

    .content {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      background: var(--shell-bg);
    }

    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    .page-header {
      margin-bottom: 24px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 4px;
    }

    .page-subtitle {
      font-size: 14px;
      color: var(--text-muted);
    }

    /* ========== DASHBOARD KPI CARDS ========== */

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .kpi-card {
      background: var(--app-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border-soft);
      transition: all 0.2s;
    }

    .kpi-card:hover {
      box-shadow: var(--card-shadow-hover);
      transform: translateY(-2px);
    }

    .kpi-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .kpi-label {
      font-size: 13px;
      color: var(--text-muted);
      font-weight: 500;
    }

    .kpi-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .kpi-icon.blue {
      background: rgba(59, 130, 246, 0.1);
      color: var(--accent);
    }

    .kpi-icon.green {
      background: rgba(22, 163, 74, 0.1);
      color: var(--success);
    }

    .kpi-icon.orange {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }

    .kpi-icon.purple {
      background: rgba(139, 92, 246, 0.1);
      color: #8b5cf6;
    }

    .kpi-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 8px;
    }

    .kpi-footer {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }

    .kpi-trend {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: 600;
    }

    .kpi-trend.up {
      background: var(--success-bg);
      color: var(--success);
    }

    .kpi-trend.down {
      background: var(--danger-bg);
      color: var(--danger);
    }

    .kpi-trend-label {
      color: var(--text-muted);
    }

    /* ========== CHART CONTAINERS ========== */

    .chart-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
      margin-bottom: 24px;
    }

    .chart-card {
      background: var(--app-bg);
      border-radius: 12px;
      padding: 24px;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border-soft);
    }

    .chart-header {
      margin-bottom: 20px;
    }

    .chart-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 4px;
    }

    .chart-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .chart-container {
      position: relative;
      height: 300px;
    }

    /* ========== TABS ========== */

    .tabs {
      display: flex;
      gap: 8px;
      border-bottom: 2px solid var(--border-soft);
      margin-bottom: 24px;
    }

    .tab {
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-muted);
      background: transparent;
      border: none;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }

    .tab:hover {
      color: var(--accent);
    }

    .tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* ========== REWRITE ENGINE ========== */

    .rewrite-grid {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 24px;
    }

    .card {
      background: var(--app-bg);
      border-radius: 12px;
      padding: 24px;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border-soft);
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-main);
      margin-bottom: 6px;
      margin-top: 16px;
    }

    label:first-of-type {
      margin-top: 0;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px 14px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      background: var(--app-bg);
      color: var(--text-main);
      font-size: 14px;
      outline: none;
      transition: all 0.2s;
      font-family: inherit;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }

    textarea {
      resize: vertical;
      font-family: inherit;
    }

    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 6px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      flex: 1;
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #b91c1c;
    }

    .status-message {
      margin-top: 12px;
      font-size: 13px;
      color: var(--text-muted);
      min-height: 18px;
    }

    .output-grid {
      display: grid;
      gap: 16px;
    }

    .output-block {
      background: #f9fafb;
      border-radius: 8px;
      padding: 16px;
      border: 1px solid var(--border-soft);
    }

    .output-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    .output-text {
      font-size: 14px;
      color: var(--text-main);
      line-height: 1.6;
      min-height: 60px;
    }

    /* ========== TABLES ========== */

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-soft);
    }

    th {
      background: #f9fafb;
      font-weight: 600;
      color: var(--text-main);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    tbody tr:hover {
      background: #f9fafb;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .badge-admin {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }

    .badge-user {
      background: rgba(59, 130, 246, 0.1);
      color: var(--accent);
    }

    /* ========== RESPONSIVE ========== */

    @media (max-width: 1024px) {
      .chart-grid {
        grid-template-columns: 1fr;
      }

      .rewrite-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 60px;
      }

      .nav-item span:not(.nav-icon) {
        display: none;
      }

      .nav-section-label {
        display: none;
      }

      .kpi-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="root">
    <!-- ========== LOGIN SCREEN ========== -->
    <div id="loginScreen">
      <div class="login-card">
        <div class="login-brand">
          <div class="login-logo">AI</div>
          <div class="login-title">ai.mdwcg</div>
          <div class="login-subtitle">Legal Billing & Time Entry Management</div>
        </div>

        <div class="form-group">
          <label class="form-label">Username</label>
          <input id="username" class="form-input" value="demo" autocomplete="username">
        </div>

        <div class="form-group">
          <label class="form-label">Password</label>
          <input id="password" class="form-input" type="password" value="demo123" autocomplete="current-password">
        </div>

        <button id="loginBtn" class="btn btn-primary">
          <span>Sign In</span>
        </button>

        <div class="login-hint">
          <strong>Demo Credentials:</strong><br>
          User: <code>demo / demo123</code><br>
          Admin: <code>admin / admin123</code>
        </div>

        <div id="loginStatus" class="login-status"></div>
      </div>
    </div>

    <!-- ========== APP SCREEN ========== -->
    <div id="appScreen">
      <!-- Header -->
      <div class="app-header">
        <div class="app-header-left">
          <div class="app-logo">AI</div>
          <div>
            <div class="app-title">ai.mdwcg</div>
            <div class="app-title-sub">Legal Billing Platform</div>
          </div>
        </div>

        <div class="app-header-right">
          <div class="user-menu">
            <div class="user-avatar" id="userAvatar">D</div>
            <div class="user-info">
              <div class="user-name" id="userName">@demo</div>
              <div class="user-role" id="userRole">User</div>
            </div>
          </div>
          <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
      </div>

      <div class="app-body">
        <!-- Sidebar -->
        <aside class="sidebar">
          <div class="nav-section">
            <div class="nav-section-label">Main</div>
            <div id="navDashboard" class="nav-item active">
              <span class="nav-icon">üìä</span>
              <span>Dashboard</span>
            </div>
            <div id="navRewrite" class="nav-item">
              <span class="nav-icon">‚úèÔ∏è</span>
              <span>Rewrite Engine</span>
            </div>
          </div>

          <div id="adminNav" class="nav-section" style="display: none;">
            <div class="nav-section-label">Admin</div>
            <div id="navAudit" class="nav-item">
              <span class="nav-icon">üìã</span>
              <span>Audit Trail</span>
            </div>
            <div id="navClients" class="nav-item">
              <span class="nav-icon">üë•</span>
              <span>Clients</span>
            </div>
          </div>

          <div class="sidebar-footer">
            Powered by Ollama<br>qwen2.5:7b
          </div>
        </aside>

        <!-- Main Content -->
        <main class="content">
          <!-- ========== DASHBOARD VIEW ========== -->
          <section id="viewDashboard" class="view active">
            <div class="page-header">
              <h1 class="page-title">Performance Dashboard</h1>
              <p class="page-subtitle">Legal billing analytics and insights</p>
            </div>

            <!-- Tabs -->
            <div class="tabs">
              <button class="tab active" data-tab="overview">Overview</button>
              <button class="tab" data-tab="clients">Clients</button>
              <button class="tab" data-tab="trends">Trends</button>
            </div>

            <!-- Overview Tab -->
            <div id="tabOverview" class="tab-content active">
              <!-- KPI Cards -->
              <div class="kpi-grid">
                <div class="kpi-card">
                  <div class="kpi-header">
                    <div class="kpi-label">Total Rewrites</div>
                    <div class="kpi-icon blue">üìù</div>
                  </div>
                  <div class="kpi-value" id="kpiRewrites">0</div>
                  <div class="kpi-footer">
                    <span class="kpi-trend up" id="kpiRewritesTrend">
                      <span>‚Üë</span>
                      <span>0%</span>
                    </span>
                    <span class="kpi-trend-label">vs last 30 days</span>
                  </div>
                </div>

                <div class="kpi-card">
                  <div class="kpi-header">
                    <div class="kpi-label">Total Hours</div>
                    <div class="kpi-icon green">‚è±Ô∏è</div>
                  </div>
                  <div class="kpi-value" id="kpiHours">0</div>
                  <div class="kpi-footer">
                    <span class="kpi-trend up" id="kpiHoursTrend">
                      <span>‚Üë</span>
                      <span>0%</span>
                    </span>
                    <span class="kpi-trend-label">vs last 30 days</span>
                  </div>
                </div>

                <div class="kpi-card">
                  <div class="kpi-header">
                    <div class="kpi-label">Active Clients</div>
                    <div class="kpi-icon orange">üë•</div>
                  </div>
                  <div class="kpi-value" id="kpiClients">0</div>
                  <div class="kpi-footer">
                    <span class="kpi-trend-label">Total clients in system</span>
                  </div>
                </div>

                <div class="kpi-card">
                  <div class="kpi-header">
                    <div class="kpi-label">Avg Hours/Entry</div>
                    <div class="kpi-icon purple">üìà</div>
                  </div>
                  <div class="kpi-value" id="kpiAvgHours">0.0</div>
                  <div class="kpi-footer">
                    <span class="kpi-trend-label">Average per time entry</span>
                  </div>
                </div>
              </div>

              <!-- Charts -->
              <div class="chart-grid">
                <div class="chart-card">
                  <div class="chart-header">
                    <div class="chart-title">Client Distribution</div>
                    <div class="chart-subtitle">Hours by client</div>
                  </div>
                  <div class="chart-container">
                    <canvas id="clientChart"></canvas>
                  </div>
                </div>

                <div class="chart-card">
                  <div class="chart-header">
                    <div class="chart-title">Monthly Trend</div>
                    <div class="chart-subtitle">Rewrites over time</div>
                  </div>
                  <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                  </div>
                </div>
              </div>

              <!-- Recent Entries -->
              <div class="card">
                <h3 class="card-title">Recent Time Entries</h3>
                <table>
                  <thead>
                    <tr>
                      <th>Client</th>
                      <th>Standard Rewrite</th>
                      <th>Hours</th>
                    </tr>
                  </thead>
                  <tbody id="dashboardRecentTable">
                    <tr><td colspan="3" style="text-align: center; color: var(--text-muted);">Loading...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Clients Tab -->
            <div id="tabClients" class="tab-content">
              <div class="card">
                <h3 class="card-title">Client Performance</h3>
                <table>
                  <thead>
                    <tr>
                      <th>Client Name</th>
                      <th>Entries</th>
                      <th>Total Hours</th>
                    </tr>
                  </thead>
                  <tbody id="clientStatsTable">
                    <tr><td colspan="3" style="text-align: center; color: var(--text-muted);">Loading...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Trends Tab -->
            <div id="tabTrends" class="tab-content">
              <div class="chart-card">
                <div class="chart-header">
                  <div class="chart-title">6-Month Activity Trend</div>
                  <div class="chart-subtitle">Rewrites and hours over the last 6 months</div>
                </div>
                <div class="chart-container" style="height: 400px;">
                  <canvas id="monthlyTrendChart"></canvas>
                </div>
              </div>
            </div>
          </section>

          <!-- ========== REWRITE ENGINE VIEW ========== -->
          <section id="viewRewrite" class="view">
            <div class="page-header">
              <h1 class="page-title">Time Entry Rewrite Engine</h1>
              <p class="page-subtitle">AI-powered billing narrative optimization</p>
            </div>

            <div class="rewrite-grid">
              <!-- Input Panel -->
              <div class="card">
                <h3 class="card-title">Time Entry Details</h3>

                <label>Client</label>
                <select id="clientSelect">
                  <option value="">Loading...</option>
                </select>

                <label>Hours</label>
                <input id="hours" type="number" step="0.1" value="1.5">

                <label>Original Narrative</label>
                <textarea id="original" rows="6" placeholder="Enter your time entry narrative..."></textarea>

                <label>Custom Rules (JSON - Optional)</label>
                <textarea id="rules" rows="5">
{
  "forbidden_terms": ["email review", "miscellaneous"],
  "required_elements": ["Include subject of work"]
}
                </textarea>

                <div class="btn-group">
                  <button id="runBtn" class="btn btn-primary">Rewrite Only</button>
                  <button id="saveBtn" class="btn btn-secondary">Rewrite & Save</button>
                </div>

                <div id="status" class="status-message"></div>
              </div>

              <!-- Output Panel -->
              <div class="card">
                <h3 class="card-title">AI Rewrites</h3>

                <div class="output-grid">
                  <div class="output-block">
                    <div class="output-label">Standard Rewrite</div>
                    <div class="output-text" id="outStandard">Results will appear here...</div>
                  </div>

                  <div class="output-block">
                    <div class="output-label">Client-Compliant</div>
                    <div class="output-text" id="outClient">Results will appear here...</div>
                  </div>

                  <div class="output-block">
                    <div class="output-label">Audit-Safe</div>
                    <div class="output-text" id="outAudit">Results will appear here...</div>
                  </div>

                  <div class="output-block">
                    <div class="output-label">AI Notes</div>
                    <div class="output-text" id="outNotes">Results will appear here...</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Recent Entries Table -->
            <div class="card" style="margin-top: 24px;">
              <h3 class="card-title">Recent Saved Entries</h3>
              <table>
                <thead>
                  <tr>
                    <th>Client</th>
                    <th>Standard Rewrite</th>
                    <th>Notes</th>
                  </tr>
                </thead>
                <tbody id="recentTableBody">
                  <tr><td colspan="3" style="text-align: center; color: var(--text-muted);">No entries yet</td></tr>
                </tbody>
              </table>
            </div>
          </section>

          <!-- ========== AUDIT TRAIL VIEW ========== -->
          <section id="viewAudit" class="view">
            <div class="page-header">
              <h1 class="page-title">Audit Trail</h1>
              <p class="page-subtitle">Complete activity log for compliance</p>
            </div>

            <div class="card">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 class="card-title" style="margin: 0;">Audit Events</h3>
                <button id="loadAuditBtn" class="btn btn-secondary" style="width: auto; padding: 8px 16px;">
                  Refresh
                </button>
              </div>

              <table>
                <thead>
                  <tr>
                    <th>Timestamp</th>
                    <th>User</th>
                    <th>Client</th>
                    <th>Original</th>
                    <th>Standard Rewrite</th>
                  </tr>
                </thead>
                <tbody id="auditTableBody">
                  <tr><td colspan="5" style="text-align: center; color: var(--text-muted);">Click Refresh to load audit events</td></tr>
                </tbody>
              </table>
            </div>
          </section>

          <!-- ========== CLIENTS MANAGEMENT VIEW ========== -->
          <section id="viewClients" class="view">
            <div class="page-header">
              <h1 class="page-title">Client Management</h1>
              <p class="page-subtitle">Configure billing guidelines and rules</p>
            </div>

            <div style="display: grid; grid-template-columns: 400px 1fr; gap: 24px;">
              <!-- Client List -->
              <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                  <h3 class="card-title" style="margin: 0;">Clients</h3>
                  <button id="adminClientNewBtn" class="btn btn-primary" style="width: auto; padding: 8px 16px;">
                    New
                  </button>
                </div>

                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Name</th>
                    </tr>
                  </thead>
                  <tbody id="adminClientTableBody">
                    <tr><td colspan="2" style="text-align: center; color: var(--text-muted);">Loading...</td></tr>
                  </tbody>
                </table>
              </div>

              <!-- Client Details -->
              <div class="card">
                <h3 class="card-title">Client Details</h3>

                <label>Client ID</label>
                <input id="adminClientId" placeholder="e.g., C004">

                <label>Client Name</label>
                <input id="adminClientName" placeholder="Client Name">

                <label>Client Code</label>
                <input id="adminClientCode" placeholder="Billing code (optional)">

                <label>Billing Guidelines</label>
                <textarea id="adminClientGuidelines" rows="4" placeholder="Paste key billing guidelines..."></textarea>

                <label>Accepted Examples</label>
                <textarea id="adminClientAccepted" rows="3" placeholder="Line-separated accepted examples..."></textarea>

                <label>Denied Examples</label>
                <textarea id="adminClientDenied" rows="3" placeholder="Line-separated denied examples..."></textarea>

                <hr style="margin: 24px 0; border: none; border-top: 1px solid var(--border-soft);">

                <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 16px;">Upload PDFs (Optional)</h4>

                <label>Guidelines PDF</label>
                <input type="file" id="guidelinesPdf" accept=".pdf" style="padding: 8px;">
                <button id="uploadGuidelinesPdfBtn" class="btn btn-secondary" style="margin-top: 8px; width: auto; padding: 8px 16px;">
                  Upload Guidelines PDF
                </button>
                <div id="guidelinesPdfStatus" class="status-message"></div>

                <label>Successful Examples PDF</label>
                <input type="file" id="successfulPdf" accept=".pdf" style="padding: 8px;">
                <button id="uploadSuccessfulPdfBtn" class="btn btn-secondary" style="margin-top: 8px; width: auto; padding: 8px 16px;">
                  Upload Successful Examples PDF
                </button>
                <div id="successfulPdfStatus" class="status-message"></div>

                <label>Failed Examples PDF</label>
                <input type="file" id="failedPdf" accept=".pdf" style="padding: 8px;">
                <button id="uploadFailedPdfBtn" class="btn btn-secondary" style="margin-top: 8px; width: auto; padding: 8px 16px;">
                  Upload Failed Examples PDF
                </button>
                <div id="failedPdfStatus" class="status-message"></div>

                <hr style="margin: 24px 0; border: none; border-top: 1px solid var(--border-soft);">

                <div class="btn-group">
                  <button id="adminClientSaveBtn" class="btn btn-primary">Save Client</button>
                  <button id="adminClientDeleteBtn" class="btn btn-danger">Delete</button>
                </div>

                <div id="adminClientStatus" class="status-message"></div>
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "http://localhost:9001";
    let authToken = null;
    let userRole = null;
    let username = null;

    // Charts
    let clientChart = null;
    let trendChart = null;
    let monthlyTrendChart = null;

    // ========== UTILITY FUNCTIONS ==========

    function buildAuthHeaders(base = {}) {
      const headers = { ...base };
      if (authToken) {
        headers["Authorization"] = "Bearer " + authToken;
      }
      return headers;
    }

    function showLoginStatus(message, isError = false) {
      const loginStatus = document.getElementById("loginStatus");
      loginStatus.textContent = message;
      loginStatus.style.color = isError ? "var(--danger)" : "var(--text-muted)";
    }

    function switchToApp() {
      document.getElementById("loginScreen").style.display = "none";
      document.getElementById("appScreen").style.display = "flex";
    }

    function switchToLogin() {
      authToken = null;
      userRole = null;
      username = null;
      document.getElementById("appScreen").style.display = "none";
      document.getElementById("loginScreen").style.display = "flex";
      showLoginStatus("", false);
    }

    function setActiveView(viewName) {
      document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
      document.querySelectorAll(".nav-item").forEach(n => n.classList.remove("active"));

      const viewMap = {
        dashboard: { view: "viewDashboard", nav: "navDashboard" },
        rewrite: { view: "viewRewrite", nav: "navRewrite" },
        audit: { view: "viewAudit", nav: "navAudit" },
        clients: { view: "viewClients", nav: "navClients" },
      };

      const target = viewMap[viewName];
      if (target) {
        document.getElementById(target.view).classList.add("active");
        document.getElementById(target.nav).classList.add("active");
      }
    }

    // ========== LOGIN ==========

    async function login() {
      const u = document.getElementById("username").value.trim();
      const p = document.getElementById("password").value;

      if (!u || !p) {
        showLoginStatus("Enter username and password.", true);
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/auth/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username: u, password: p })
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || `HTTP ${res.status}`);
        }

        const data = await res.json();
        authToken = data.access_token;
        userRole = data.role;
        username = data.username;

        document.getElementById("userName").textContent = "@" + username;
        document.getElementById("userRole").textContent = userRole;
        document.getElementById("userAvatar").textContent = username[0].toUpperCase();

        if (userRole === "admin") {
          document.getElementById("adminNav").style.display = "block";
        }

        showLoginStatus("");
        switchToApp();
        setActiveView("dashboard");

        loadClients();
        loadDashboard();
        loadRecentEntries();
      } catch (err) {
        console.error(err);
        showLoginStatus("Login failed: " + err.message, true);
      }
    }

    // ========== DASHBOARD ==========

    async function loadDashboard() {
      try {
        const res = await fetch(`${API_BASE}/analytics/dashboard`, {
          headers: buildAuthHeaders(),
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        updateDashboardKPIs(data.overview);
        updateClientChart(data.client_breakdown);
        updateTrendChart(data.monthly_trend);
        updateClientStatsTable(data.client_breakdown);
        loadDashboardRecent();
      } catch (err) {
        console.error("Dashboard load error:", err);
      }
    }

    function updateDashboardKPIs(overview) {
      document.getElementById("kpiRewrites").textContent = overview.total_rewrites;
      document.getElementById("kpiHours").textContent = overview.total_hours.toFixed(1);
      document.getElementById("kpiClients").textContent = overview.total_clients;
      document.getElementById("kpiAvgHours").textContent = overview.avg_hours_per_entry.toFixed(1);

      // Trends
      const rewritesTrendEl = document.getElementById("kpiRewritesTrend");
      const hoursTrendEl = document.getElementById("kpiHoursTrend");

      const rewriteChange = overview.rewrites_change_30d;
      const hoursChange = overview.hours_change_30d;

      rewritesTrendEl.className = "kpi-trend " + (rewriteChange >= 0 ? "up" : "down");
      rewritesTrendEl.innerHTML = `<span>${rewriteChange >= 0 ? "‚Üë" : "‚Üì"}</span><span>${Math.abs(rewriteChange).toFixed(1)}%</span>`;

      hoursTrendEl.className = "kpi-trend " + (hoursChange >= 0 ? "up" : "down");
      hoursTrendEl.innerHTML = `<span>${hoursChange >= 0 ? "‚Üë" : "‚Üì"}</span><span>${Math.abs(hoursChange).toFixed(1)}%</span>`;
    }

    function updateClientChart(clientData) {
      const ctx = document.getElementById("clientChart");
      if (!ctx) return;

      if (clientChart) {
        clientChart.destroy();
      }

      const labels = clientData.map(c => c.name);
      const hours = clientData.map(c => c.hours);

      clientChart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: labels,
          datasets: [{
            data: hours,
            backgroundColor: [
              "#3b82f6",
              "#10b981",
              "#f59e0b",
              "#8b5cf6",
              "#ec4899",
              "#6366f1",
              "#14b8a6",
              "#f97316",
            ],
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "right",
            }
          }
        }
      });
    }

    function updateTrendChart(monthlyData) {
      const ctx = document.getElementById("trendChart");
      if (!ctx) return;

      if (trendChart) {
        trendChart.destroy();
      }

      const labels = monthlyData.map(m => m.month);
      const rewrites = monthlyData.map(m => m.rewrites);

      trendChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "Rewrites",
            data: rewrites,
            borderColor: "#3b82f6",
            backgroundColor: "rgba(59, 130, 246, 0.1)",
            tension: 0.4,
            fill: true,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false,
            }
          },
          scales: {
            y: {
              beginAtZero: true,
            }
          }
        }
      });

      // Monthly trend chart (on Trends tab)
      const ctx2 = document.getElementById("monthlyTrendChart");
      if (!ctx2) return;

      if (monthlyTrendChart) {
        monthlyTrendChart.destroy();
      }

      const hours = monthlyData.map(m => m.hours);

      monthlyTrendChart = new Chart(ctx2, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Rewrites",
              data: rewrites,
              backgroundColor: "rgba(59, 130, 246, 0.7)",
              yAxisID: "y",
            },
            {
              label: "Hours",
              data: hours,
              backgroundColor: "rgba(16, 185, 129, 0.7)",
              yAxisID: "y1",
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              type: "linear",
              display: true,
              position: "left",
              beginAtZero: true,
              title: {
                display: true,
                text: "Rewrites"
              }
            },
            y1: {
              type: "linear",
              display: true,
              position: "right",
              beginAtZero: true,
              grid: {
                drawOnChartArea: false,
              },
              title: {
                display: true,
                text: "Hours"
              }
            },
          }
        }
      });
    }

    function updateClientStatsTable(clientData) {
      const tbody = document.getElementById("clientStatsTable");
      if (!tbody) return;

      tbody.innerHTML = "";

      if (!clientData.length) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-muted);">No client data</td></tr>';
        return;
      }

      clientData.forEach(c => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.name}</td>
          <td>${c.entries}</td>
          <td>${c.hours.toFixed(1)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function loadDashboardRecent() {
      try {
        const res = await fetch(`${API_BASE}/rewrites/recent?limit=10`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const rows = await res.json();
        const tbody = document.getElementById("dashboardRecentTable");
        tbody.innerHTML = "";

        if (!rows.length) {
          tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-muted);">No entries yet</td></tr>';
          return;
        }

        rows.forEach(row => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.client.name}</td>
            <td>${row.rewrite.standard || ""}</td>
            <td>${row.rewrite.notes || ""}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
      }
    }

    // ========== REWRITE ENGINE ==========

    async function loadClients() {
      try {
        const res = await fetch(`${API_BASE}/clients/`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const clients = await res.json();

        const select = document.getElementById("clientSelect");
        select.innerHTML = '<option value="">Select a client...</option>';

        clients.forEach(c => {
          const option = document.createElement("option");
          option.value = c.id;
          option.textContent = `${c.name} (${c.id})`;
          select.appendChild(option);
        });
      } catch (err) {
        console.error(err);
      }
    }

    async function loadRecentEntries() {
      try {
        const res = await fetch(`${API_BASE}/rewrites/recent?limit=20`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const rows = await res.json();

        const tbody = document.getElementById("recentTableBody");
        tbody.innerHTML = "";

        if (!rows.length) {
          tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-muted);">No saved entries yet</td></tr>';
          return;
        }

        rows.forEach(row => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.client.name}</td>
            <td>${row.rewrite.standard || ""}</td>
            <td>${row.rewrite.notes || ""}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
      }
    }

    async function rewriteOnly() {
      if (!authToken) {
        document.getElementById("status").textContent = "Please log in first.";
        return;
      }

      const original = document.getElementById("original").value.trim();
      const hours = parseFloat(document.getElementById("hours").value || "0");

      if (!original) {
        document.getElementById("status").textContent = "Please enter an original narrative.";
        return;
      }

      let rules = null;
      const rulesText = document.getElementById("rules").value.trim();
      if (rulesText) {
        try {
          rules = JSON.parse(rulesText);
        } catch (e) {
          document.getElementById("status").textContent = "Rules JSON is invalid.";
          return;
        }
      }

      document.getElementById("status").textContent = "Rewriting...";
      document.getElementById("outStandard").textContent = "";
      document.getElementById("outClient").textContent = "";
      document.getElementById("outAudit").textContent = "";
      document.getElementById("outNotes").textContent = "";

      try {
        const res = await fetch(`${API_BASE}/rewrites/rewrite`, {
          method: "POST",
          headers: buildAuthHeaders({ "Content-Type": "application/json" }),
          body: JSON.stringify({ original, hours, rules })
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || `HTTP ${res.status}`);
        }

        const data = await res.json();
        document.getElementById("outStandard").textContent = data.standard || "";
        document.getElementById("outClient").textContent = data.client_compliant || "";
        document.getElementById("outAudit").textContent = data.audit_safe || "";
        document.getElementById("outNotes").textContent = data.notes || "";
        document.getElementById("status").textContent = "Rewrite complete.";
      } catch (err) {
        console.error(err);
        document.getElementById("status").textContent = "Error: " + err.message;
      }
    }

    async function rewriteAndSave() {
      if (!authToken) {
        document.getElementById("status").textContent = "Please log in first.";
        return;
      }

      const original = document.getElementById("original").value.trim();
      const hours = parseFloat(document.getElementById("hours").value || "0");
      const clientId = document.getElementById("clientSelect").value;

      if (!clientId) {
        document.getElementById("status").textContent = "Please select a client.";
        return;
      }
      if (!original) {
        document.getElementById("status").textContent = "Please enter an original narrative.";
        return;
      }

      document.getElementById("status").textContent = "Rewriting and saving...";
      document.getElementById("outStandard").textContent = "";
      document.getElementById("outClient").textContent = "";
      document.getElementById("outAudit").textContent = "";
      document.getElementById("outNotes").textContent = "";

      try {
        const res = await fetch(`${API_BASE}/rewrites/rewrite-and-save`, {
          method: "POST",
          headers: buildAuthHeaders({ "Content-Type": "application/json" }),
          body: JSON.stringify({ client_id: clientId, original, hours })
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || `HTTP ${res.status}`);
        }

        const data = await res.json();
        document.getElementById("outStandard").textContent = data.rewrite.standard || "";
        document.getElementById("outClient").textContent = data.rewrite.client_compliant || "";
        document.getElementById("outAudit").textContent = data.rewrite.audit_safe || "";
        document.getElementById("outNotes").textContent = data.rewrite.notes || "";
        document.getElementById("status").textContent = "Rewrite saved successfully.";

        loadRecentEntries();
        loadDashboard();
      } catch (err) {
        console.error(err);
        document.getElementById("status").textContent = "Error: " + err.message;
      }
    }

    // ========== AUDIT ==========

    async function loadAudit() {
      if (!authToken || userRole !== "admin") return;

      try {
        const res = await fetch(`${API_BASE}/admin/audit-events?limit=50`, {
          headers: buildAuthHeaders(),
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || `HTTP ${res.status}`);
        }

        const rows = await res.json();
        const tbody = document.getElementById("auditTableBody");
        tbody.innerHTML = "";

        if (!rows.length) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-muted);">No audit events yet</td></tr>';
          return;
        }

        rows.forEach(row => {
          const when = new Date(row.timestamp).toLocaleString();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${when}</td>
            <td>
              ${row.username}
              <span class="badge badge-${row.role}">${row.role}</span>
            </td>
            <td>${row.client.name}</td>
            <td>${row.original.substring(0, 80)}...</td>
            <td>${row.standard.substring(0, 80)}...</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
      }
    }

    // ========== CLIENT MANAGEMENT ==========

    async function loadAdminClients() {
      if (!authToken || userRole !== "admin") return;

      try {
        const res = await fetch(`${API_BASE}/admin/clients`, {
          headers: buildAuthHeaders(),
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || `HTTP ${res.status}`);
        }

        const clients = await res.json();
        const tbody = document.getElementById("adminClientTableBody");
        tbody.innerHTML = "";

        if (!clients.length) {
          tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: var(--text-muted);">No clients yet</td></tr>';
          return;
        }

        clients.forEach(c => {
          const tr = document.createElement("tr");
          tr.style.cursor = "pointer";
          tr.innerHTML = `
            <td>${c.id}</td>
            <td>${c.name}</td>
          `;
          tr.addEventListener("click", () => {
            populateClientForm(c);
          });
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
      }
    }

    function populateClientForm(c) {
      document.getElementById("adminClientId").value = c.id;
      document.getElementById("adminClientName").value = c.name || "";
      document.getElementById("adminClientCode").value = c.code || "";
      document.getElementById("adminClientGuidelines").value = c.billing_guidelines || "";
      document.getElementById("adminClientAccepted").value = c.accepted_examples || "";
      document.getElementById("adminClientDenied").value = c.denied_examples || "";
      document.getElementById("adminClientStatus").textContent = `Loaded client ${c.id}.`;
    }

    function clearClientForm() {
      document.getElementById("adminClientId").value = "";
      document.getElementById("adminClientName").value = "";
      document.getElementById("adminClientCode").value = "";
      document.getElementById("adminClientGuidelines").value = "";
      document.getElementById("adminClientAccepted").value = "";
      document.getElementById("adminClientDenied").value = "";
      document.getElementById("adminClientStatus").textContent = "";
    }

    async function saveClient() {
      if (!authToken || userRole !== "admin") return;

      const id = document.getElementById("adminClientId").value.trim();
      const name = document.getElementById("adminClientName").value.trim();
      const code = document.getElementById("adminClientCode").value.trim();
      const guidelines = document.getElementById("adminClientGuidelines").value.trim();
      const accepted = document.getElementById("adminClientAccepted").value.trim();
      const denied = document.getElementById("adminClientDenied").value.trim();

      if (!id || !name) {
        document.getElementById("adminClientStatus").textContent = "Client ID and Name are required.";
        return;
      }

      const payload = {
        name,
        code: code || null,
        billing_guidelines: guidelines || null,
        accepted_examples: accepted || null,
        denied_examples: denied || null,
      };

      const method = "PUT";
      const url = `${API_BASE}/admin/clients/${encodeURIComponent(id)}`;

      try {
        document.getElementById("adminClientStatus").textContent = "Saving client...";

        const res = await fetch(url, {
          method,
          headers: buildAuthHeaders({ "Content-Type": "application/json" }),
          body: JSON.stringify(payload),
        });

        if (res.status === 404) {
          const createRes = await fetch(`${API_BASE}/admin/clients`, {
            method: "POST",
            headers: buildAuthHeaders({ "Content-Type": "application/json" }),
            body: JSON.stringify({ id, ...payload }),
          });

          if (!createRes.ok) {
            const err2 = await createRes.json().catch(() => ({}));
            throw new Error(err2.detail || `HTTP ${createRes.status}`);
          }

          const saved2 = await createRes.json();
          populateClientForm(saved2);
          document.getElementById("adminClientStatus").textContent = "Client created.";
          loadClients();
          loadAdminClients();
          return;
        }

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || `HTTP ${res.status}`);
        }

        const saved = await res.json();
        populateClientForm(saved);
        document.getElementById("adminClientStatus").textContent = "Client saved.";
        loadClients();
        loadAdminClients();
      } catch (err) {
        console.error(err);
        document.getElementById("adminClientStatus").textContent = "Error: " + err.message;
      }
    }

    async function deleteClient() {
      if (!authToken || userRole !== "admin") return;

      const id = document.getElementById("adminClientId").value.trim();
      if (!id) {
        document.getElementById("adminClientStatus").textContent = "Select a client to delete.";
        return;
      }

      if (!confirm(`Delete client ${id}? This cannot be undone.`)) {
        return;
      }

      try {
        document.getElementById("adminClientStatus").textContent = "Deleting client...";

        const res = await fetch(`${API_BASE}/admin/clients/${encodeURIComponent(id)}`, {
          method: "DELETE",
          headers: buildAuthHeaders(),
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || `HTTP ${res.status}`);
        }

        document.getElementById("adminClientStatus").textContent = "Client deleted.";
        clearClientForm();
        loadClients();
        loadAdminClients();
      } catch (err) {
        console.error(err);
        document.getElementById("adminClientStatus").textContent = "Error: " + err.message;
      }
    }

    // ========== PDF UPLOAD FUNCTIONS ==========

    async function uploadGuidelinesPdf() {
      if (!authToken || userRole !== "admin") return;

      const id = document.getElementById("adminClientId").value.trim();
      if (!id) {
        document.getElementById("guidelinesPdfStatus").textContent = "Please select a client first.";
        return;
      }

      const fileInput = document.getElementById("guidelinesPdf");
      const file = fileInput.files[0];

      if (!file) {
        document.getElementById("guidelinesPdfStatus").textContent = "Please select a PDF file.";
        return;
      }

      const formData = new FormData();
      formData.append("file", file);

      try {
        document.getElementById("guidelinesPdfStatus").textContent = "Uploading...";

        const res = await fetch(`${API_BASE}/admin/clients/${encodeURIComponent(id)}/upload-guidelines-pdf`, {
          method: "POST",
          headers: buildAuthHeaders(),
          body: formData,
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || `HTTP ${res.status}`);
        }

        const data = await res.json();
        document.getElementById("guidelinesPdfStatus").textContent = data.message;
        fileInput.value = "";
        loadAdminClients();
      } catch (err) {
        console.error(err);
        document.getElementById("guidelinesPdfStatus").textContent = "Error: " + err.message;
      }
    }

    async function uploadSuccessfulPdf() {
      if (!authToken || userRole !== "admin") return;

      const id = document.getElementById("adminClientId").value.trim();
      if (!id) {
        document.getElementById("successfulPdfStatus").textContent = "Please select a client first.";
        return;
      }

      const fileInput = document.getElementById("successfulPdf");
      const file = fileInput.files[0];

      if (!file) {
        document.getElementById("successfulPdfStatus").textContent = "Please select a PDF file.";
        return;
      }

      const formData = new FormData();
      formData.append("file", file);

      try {
        document.getElementById("successfulPdfStatus").textContent = "Uploading...";

        const res = await fetch(`${API_BASE}/admin/clients/${encodeURIComponent(id)}/upload-successful-examples-pdf`, {
          method: "POST",
          headers: buildAuthHeaders(),
          body: formData,
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || `HTTP ${res.status}`);
        }

        const data = await res.json();
        document.getElementById("successfulPdfStatus").textContent = data.message;
        fileInput.value = "";
        loadAdminClients();
      } catch (err) {
        console.error(err);
        document.getElementById("successfulPdfStatus").textContent = "Error: " + err.message;
      }
    }

    async function uploadFailedPdf() {
      if (!authToken || userRole !== "admin") return;

      const id = document.getElementById("adminClientId").value.trim();
      if (!id) {
        document.getElementById("failedPdfStatus").textContent = "Please select a client first.";
        return;
      }

      const fileInput = document.getElementById("failedPdf");
      const file = fileInput.files[0];

      if (!file) {
        document.getElementById("failedPdfStatus").textContent = "Please select a PDF file.";
        return;
      }

      const formData = new FormData();
      formData.append("file", file);

      try {
        document.getElementById("failedPdfStatus").textContent = "Uploading...";

        const res = await fetch(`${API_BASE}/admin/clients/${encodeURIComponent(id)}/upload-failed-examples-pdf`, {
          method: "POST",
          headers: buildAuthHeaders(),
          body: formData,
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || `HTTP ${res.status}`);
        }

        const data = await res.json();
        document.getElementById("failedPdfStatus").textContent = data.message;
        fileInput.value = "";
        loadAdminClients();
      } catch (err) {
        console.error(err);
        document.getElementById("failedPdfStatus").textContent = "Error: " + err.message;
      }
    }

    // ========== EVENT LISTENERS ==========

    document.getElementById("loginBtn").addEventListener("click", login);
    document.getElementById("logoutBtn").addEventListener("click", switchToLogin);

    // Navigation
    document.getElementById("navDashboard").addEventListener("click", () => {
      setActiveView("dashboard");
      loadDashboard();
    });

    document.getElementById("navRewrite").addEventListener("click", () => {
      setActiveView("rewrite");
    });

    document.getElementById("navAudit").addEventListener("click", () => {
      if (userRole !== "admin") return;
      setActiveView("audit");
      loadAudit();
    });

    document.getElementById("navClients").addEventListener("click", () => {
      if (userRole !== "admin") return;
      setActiveView("clients");
      loadAdminClients();
    });

    // Rewrite
    document.getElementById("runBtn").addEventListener("click", rewriteOnly);
    document.getElementById("saveBtn").addEventListener("click", rewriteAndSave);

    // Audit
    document.getElementById("loadAuditBtn").addEventListener("click", loadAudit);

    // Clients
    document.getElementById("adminClientNewBtn").addEventListener("click", clearClientForm);
    document.getElementById("adminClientSaveBtn").addEventListener("click", saveClient);
    document.getElementById("adminClientDeleteBtn").addEventListener("click", deleteClient);

    // PDF Uploads
    document.getElementById("uploadGuidelinesPdfBtn").addEventListener("click", uploadGuidelinesPdf);
    document.getElementById("uploadSuccessfulPdfBtn").addEventListener("click", uploadSuccessfulPdf);
    document.getElementById("uploadFailedPdfBtn").addEventListener("click", uploadFailedPdf);

    // Tabs
    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        const tabName = tab.dataset.tab;

        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(tc => tc.classList.remove("active"));

        tab.classList.add("active");
        document.getElementById("tab" + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add("active");
      });
    });

    // Allow Enter key to login
    document.getElementById("password").addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        login();
      }
    });
  </script>
</body>
</html>
